<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
  <title>expr (REXML::XPathParser)</title>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <link rel="stylesheet" href="../../.././rdoc-style.css" type="text/css" media="screen" />
</head>
<body class="standalone-code">
  <pre>     <span class="ruby-comment cmt"># File lib/rexml/xpath_parser.rb, line 156</span>
156:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">expr</span>( <span class="ruby-identifier">path_stack</span>, <span class="ruby-identifier">nodeset</span>, <span class="ruby-identifier">context</span>=<span class="ruby-keyword kw">nil</span> )
157:       <span class="ruby-comment cmt">#puts &quot;#&quot;*15</span>
158:       <span class="ruby-comment cmt">#puts &quot;In expr with #{path_stack.inspect}&quot;</span>
159:       <span class="ruby-comment cmt">#puts &quot;Returning&quot; if path_stack.length == 0 || nodeset.length == 0</span>
160:       <span class="ruby-identifier">node_types</span> = <span class="ruby-constant">ELEMENTS</span>
161:       <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">nodeset</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">path_stack</span>.<span class="ruby-identifier">length</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">nodeset</span>.<span class="ruby-identifier">length</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
162:       <span class="ruby-keyword kw">while</span> <span class="ruby-identifier">path_stack</span>.<span class="ruby-identifier">length</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>
163:         <span class="ruby-comment cmt">#puts &quot;#&quot;*5</span>
164:         <span class="ruby-comment cmt">#puts &quot;Path stack = #{path_stack.inspect}&quot;</span>
165:         <span class="ruby-comment cmt">#puts &quot;Nodeset is #{nodeset.inspect}&quot;</span>
166:         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">nodeset</span>.<span class="ruby-identifier">length</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
167:           <span class="ruby-identifier">path_stack</span>.<span class="ruby-identifier">clear</span>
168:           <span class="ruby-keyword kw">return</span> []
169:         <span class="ruby-keyword kw">end</span>
170:         <span class="ruby-keyword kw">case</span> (<span class="ruby-identifier">op</span> = <span class="ruby-identifier">path_stack</span>.<span class="ruby-identifier">shift</span>)
171:         <span class="ruby-keyword kw">when</span> <span class="ruby-identifier">:document</span>
172:           <span class="ruby-identifier">nodeset</span> = [ <span class="ruby-identifier">nodeset</span>[<span class="ruby-value">0</span>].<span class="ruby-identifier">root_node</span> ]
173:           <span class="ruby-comment cmt">#puts &quot;:document, nodeset = #{nodeset.inspect}&quot;</span>
174: 
175:         <span class="ruby-keyword kw">when</span> <span class="ruby-identifier">:qname</span>
176:           <span class="ruby-comment cmt">#puts &quot;IN QNAME&quot;</span>
177:           <span class="ruby-identifier">prefix</span> = <span class="ruby-identifier">path_stack</span>.<span class="ruby-identifier">shift</span>
178:           <span class="ruby-identifier">name</span> = <span class="ruby-identifier">path_stack</span>.<span class="ruby-identifier">shift</span>
179:           <span class="ruby-identifier">nodeset</span>.<span class="ruby-identifier">delete_if</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">node</span><span class="ruby-operator">|</span>
180:             <span class="ruby-comment cmt"># FIXME: This DOUBLES the time XPath searches take</span>
181:             <span class="ruby-identifier">ns</span> = <span class="ruby-identifier">get_namespace</span>( <span class="ruby-identifier">node</span>, <span class="ruby-identifier">prefix</span> )
182:             <span class="ruby-comment cmt">#puts &quot;NS = #{ns.inspect}&quot;</span>
183:             <span class="ruby-comment cmt">#puts &quot;node.node_type == :element =&gt; #{node.node_type == :element}&quot;</span>
184:             <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">node</span>.<span class="ruby-identifier">node_type</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">:element</span>
185:               <span class="ruby-comment cmt">#puts &quot;node.name == #{name} =&gt; #{node.name == name}&quot;</span>
186:               <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">node</span>.<span class="ruby-identifier">name</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">name</span>
187:                 <span class="ruby-comment cmt">#puts &quot;node.namespace == #{ns.inspect} =&gt; #{node.namespace == ns}&quot;</span>
188:               <span class="ruby-keyword kw">end</span>
189:             <span class="ruby-keyword kw">end</span>
190:             <span class="ruby-operator">!</span>(<span class="ruby-identifier">node</span>.<span class="ruby-identifier">node_type</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">:element</span> <span class="ruby-keyword kw">and</span> 
191:               <span class="ruby-identifier">node</span>.<span class="ruby-identifier">name</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">name</span> <span class="ruby-keyword kw">and</span> 
192:               <span class="ruby-identifier">node</span>.<span class="ruby-identifier">namespace</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">ns</span> )
193:           <span class="ruby-keyword kw">end</span>
194:           <span class="ruby-identifier">node_types</span> = <span class="ruby-constant">ELEMENTS</span>
195: 
196:         <span class="ruby-keyword kw">when</span> <span class="ruby-identifier">:any</span>
197:           <span class="ruby-comment cmt">#puts &quot;ANY 1: nodeset = #{nodeset.inspect}&quot;</span>
198:           <span class="ruby-comment cmt">#puts &quot;ANY 1: node_types = #{node_types.inspect}&quot;</span>
199:           <span class="ruby-identifier">nodeset</span>.<span class="ruby-identifier">delete_if</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">node</span><span class="ruby-operator">|</span> <span class="ruby-operator">!</span><span class="ruby-identifier">node_types</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">node</span>.<span class="ruby-identifier">node_type</span>) }
200:           <span class="ruby-comment cmt">#puts &quot;ANY 2: nodeset = #{nodeset.inspect}&quot;</span>
201: 
202:         <span class="ruby-keyword kw">when</span> <span class="ruby-identifier">:self</span>
203:           <span class="ruby-comment cmt"># This space left intentionally blank</span>
204: 
205:         <span class="ruby-keyword kw">when</span> <span class="ruby-identifier">:processing_instruction</span>
206:           <span class="ruby-identifier">target</span> = <span class="ruby-identifier">path_stack</span>.<span class="ruby-identifier">shift</span>
207:           <span class="ruby-identifier">nodeset</span>.<span class="ruby-identifier">delete_if</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">node</span><span class="ruby-operator">|</span>
208:             (<span class="ruby-identifier">node</span>.<span class="ruby-identifier">node_type</span> <span class="ruby-operator">!=</span> <span class="ruby-identifier">:processing_instruction</span>) <span class="ruby-keyword kw">or</span> 
209:             ( <span class="ruby-identifier">target!</span>=<span class="ruby-value str">''</span> <span class="ruby-keyword kw">and</span> ( <span class="ruby-identifier">node</span>.<span class="ruby-identifier">target</span> <span class="ruby-operator">!=</span> <span class="ruby-identifier">target</span> ) )
210:           <span class="ruby-keyword kw">end</span>
211: 
212:         <span class="ruby-keyword kw">when</span> <span class="ruby-identifier">:text</span>
213:           <span class="ruby-identifier">nodeset</span>.<span class="ruby-identifier">delete_if</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">node</span><span class="ruby-operator">|</span> <span class="ruby-identifier">node</span>.<span class="ruby-identifier">node_type</span> <span class="ruby-operator">!=</span> <span class="ruby-identifier">:text</span> }
214: 
215:         <span class="ruby-keyword kw">when</span> <span class="ruby-identifier">:comment</span>
216:           <span class="ruby-identifier">nodeset</span>.<span class="ruby-identifier">delete_if</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">node</span><span class="ruby-operator">|</span> <span class="ruby-identifier">node</span>.<span class="ruby-identifier">node_type</span> <span class="ruby-operator">!=</span> <span class="ruby-identifier">:comment</span> }
217: 
218:         <span class="ruby-keyword kw">when</span> <span class="ruby-identifier">:node</span>
219:           <span class="ruby-comment cmt"># This space left intentionally blank</span>
220:           <span class="ruby-identifier">node_types</span> = <span class="ruby-constant">ALL</span>
221: 
222:         <span class="ruby-keyword kw">when</span> <span class="ruby-identifier">:child</span>
223:           <span class="ruby-identifier">new_nodeset</span> = []
224:           <span class="ruby-identifier">nt</span> = <span class="ruby-keyword kw">nil</span>
225:           <span class="ruby-identifier">nodeset</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">node</span><span class="ruby-operator">|</span>
226:             <span class="ruby-identifier">nt</span> = <span class="ruby-identifier">node</span>.<span class="ruby-identifier">node_type</span>
227:             <span class="ruby-identifier">new_nodeset</span> <span class="ruby-operator">+=</span> <span class="ruby-identifier">node</span>.<span class="ruby-identifier">children</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">nt</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">:element</span> <span class="ruby-keyword kw">or</span> <span class="ruby-identifier">nt</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">:document</span>
228:           <span class="ruby-keyword kw">end</span>
229:           <span class="ruby-identifier">nodeset</span> = <span class="ruby-identifier">new_nodeset</span>
230:           <span class="ruby-identifier">node_types</span> = <span class="ruby-constant">ELEMENTS</span>
231: 
232:         <span class="ruby-keyword kw">when</span> <span class="ruby-identifier">:literal</span>
233:           <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">path_stack</span>.<span class="ruby-identifier">shift</span>
234:         
235:         <span class="ruby-keyword kw">when</span> <span class="ruby-identifier">:attribute</span>
236:           <span class="ruby-identifier">new_nodeset</span> = []
237:           <span class="ruby-keyword kw">case</span> <span class="ruby-identifier">path_stack</span>.<span class="ruby-identifier">shift</span>
238:           <span class="ruby-keyword kw">when</span> <span class="ruby-identifier">:qname</span>
239:             <span class="ruby-identifier">prefix</span> = <span class="ruby-identifier">path_stack</span>.<span class="ruby-identifier">shift</span>
240:             <span class="ruby-identifier">name</span> = <span class="ruby-identifier">path_stack</span>.<span class="ruby-identifier">shift</span>
241:             <span class="ruby-keyword kw">for</span> <span class="ruby-identifier">element</span> <span class="ruby-keyword kw">in</span> <span class="ruby-identifier">nodeset</span>
242:               <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">element</span>.<span class="ruby-identifier">node_type</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">:element</span>
243:                 <span class="ruby-comment cmt">#puts &quot;Element name = #{element.name}&quot;</span>
244:                 <span class="ruby-comment cmt">#puts &quot;get_namespace( #{element.inspect}, #{prefix} ) = #{get_namespace(element, prefix)}&quot;</span>
245:                 <span class="ruby-identifier">attrib</span> = <span class="ruby-identifier">element</span>.<span class="ruby-identifier">attribute</span>( <span class="ruby-identifier">name</span>, <span class="ruby-identifier">get_namespace</span>(<span class="ruby-identifier">element</span>, <span class="ruby-identifier">prefix</span>) )
246:                 <span class="ruby-comment cmt">#puts &quot;attrib = #{attrib.inspect}&quot;</span>
247:                 <span class="ruby-identifier">new_nodeset</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">attrib</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">attrib</span>
248:               <span class="ruby-keyword kw">end</span>
249:             <span class="ruby-keyword kw">end</span>
250:           <span class="ruby-keyword kw">when</span> <span class="ruby-identifier">:any</span>
251:             <span class="ruby-comment cmt">#puts &quot;ANY&quot;</span>
252:             <span class="ruby-keyword kw">for</span> <span class="ruby-identifier">element</span> <span class="ruby-keyword kw">in</span> <span class="ruby-identifier">nodeset</span>
253:               <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">element</span>.<span class="ruby-identifier">node_type</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">:element</span>
254:                 <span class="ruby-identifier">new_nodeset</span> <span class="ruby-operator">+=</span> <span class="ruby-identifier">element</span>.<span class="ruby-identifier">attributes</span>.<span class="ruby-identifier">to_a</span>
255:               <span class="ruby-keyword kw">end</span>
256:             <span class="ruby-keyword kw">end</span>
257:           <span class="ruby-keyword kw">end</span>
258:           <span class="ruby-identifier">nodeset</span> = <span class="ruby-identifier">new_nodeset</span>
259: 
260:         <span class="ruby-keyword kw">when</span> <span class="ruby-identifier">:parent</span>
261:           <span class="ruby-comment cmt">#puts &quot;PARENT 1: nodeset = #{nodeset}&quot;</span>
262:           <span class="ruby-identifier">nodeset</span> = <span class="ruby-identifier">nodeset</span>.<span class="ruby-identifier">collect</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">n</span><span class="ruby-operator">|</span> <span class="ruby-identifier">n</span>.<span class="ruby-identifier">parent</span>}.<span class="ruby-identifier">compact</span>
263:           <span class="ruby-comment cmt">#nodeset = expr(path_stack.dclone, nodeset.collect{|n| n.parent}.compact)</span>
264:           <span class="ruby-comment cmt">#puts &quot;PARENT 2: nodeset = #{nodeset.inspect}&quot;</span>
265:           <span class="ruby-identifier">node_types</span> = <span class="ruby-constant">ELEMENTS</span>
266: 
267:         <span class="ruby-keyword kw">when</span> <span class="ruby-identifier">:ancestor</span>
268:           <span class="ruby-identifier">new_nodeset</span> = []
269:           <span class="ruby-identifier">nodeset</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">node</span><span class="ruby-operator">|</span>
270:             <span class="ruby-keyword kw">while</span> <span class="ruby-identifier">node</span>.<span class="ruby-identifier">parent</span>
271:               <span class="ruby-identifier">node</span> = <span class="ruby-identifier">node</span>.<span class="ruby-identifier">parent</span>
272:               <span class="ruby-identifier">new_nodeset</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">node</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">new_nodeset</span>.<span class="ruby-identifier">include?</span> <span class="ruby-identifier">node</span>
273:             <span class="ruby-keyword kw">end</span>
274:           <span class="ruby-keyword kw">end</span>
275:           <span class="ruby-identifier">nodeset</span> = <span class="ruby-identifier">new_nodeset</span>
276:           <span class="ruby-identifier">node_types</span> = <span class="ruby-constant">ELEMENTS</span>
277: 
278:         <span class="ruby-keyword kw">when</span> <span class="ruby-identifier">:ancestor_or_self</span>
279:           <span class="ruby-identifier">new_nodeset</span> = []
280:           <span class="ruby-identifier">nodeset</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">node</span><span class="ruby-operator">|</span>
281:             <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">node</span>.<span class="ruby-identifier">node_type</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">:element</span>
282:               <span class="ruby-identifier">new_nodeset</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">node</span>
283:               <span class="ruby-keyword kw">while</span> ( <span class="ruby-identifier">node</span>.<span class="ruby-identifier">parent</span> )
284:                 <span class="ruby-identifier">node</span> = <span class="ruby-identifier">node</span>.<span class="ruby-identifier">parent</span>
285:                 <span class="ruby-identifier">new_nodeset</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">node</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">new_nodeset</span>.<span class="ruby-identifier">include?</span> <span class="ruby-identifier">node</span>
286:               <span class="ruby-keyword kw">end</span>
287:             <span class="ruby-keyword kw">end</span>
288:           <span class="ruby-keyword kw">end</span>
289:           <span class="ruby-identifier">nodeset</span> = <span class="ruby-identifier">new_nodeset</span>
290:           <span class="ruby-identifier">node_types</span> = <span class="ruby-constant">ELEMENTS</span>
291: 
292:         <span class="ruby-keyword kw">when</span> <span class="ruby-identifier">:predicate</span>
293:           <span class="ruby-identifier">new_nodeset</span> = []
294:           <span class="ruby-identifier">subcontext</span> = { <span class="ruby-identifier">:size</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">nodeset</span>.<span class="ruby-identifier">size</span> }
295:           <span class="ruby-identifier">pred</span> = <span class="ruby-identifier">path_stack</span>.<span class="ruby-identifier">shift</span>
296:           <span class="ruby-identifier">nodeset</span>.<span class="ruby-identifier">each_with_index</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">node</span>, <span class="ruby-identifier">index</span><span class="ruby-operator">|</span>
297:             <span class="ruby-identifier">subcontext</span>[ <span class="ruby-identifier">:node</span> ] = <span class="ruby-identifier">node</span>
298:             <span class="ruby-comment cmt">#puts &quot;PREDICATE SETTING CONTEXT INDEX TO #{index+1}&quot;</span>
299:             <span class="ruby-identifier">subcontext</span>[ <span class="ruby-identifier">:index</span> ] = <span class="ruby-identifier">index</span><span class="ruby-operator">+</span><span class="ruby-value">1</span>
300:             <span class="ruby-identifier">pc</span> = <span class="ruby-identifier">pred</span>.<span class="ruby-identifier">dclone</span>
301:             <span class="ruby-comment cmt">#puts &quot;#{node.hash}) Recursing with #{pred.inspect} and [#{node.inspect}]&quot;</span>
302:             <span class="ruby-identifier">result</span> = <span class="ruby-identifier">expr</span>( <span class="ruby-identifier">pc</span>, [<span class="ruby-identifier">node</span>], <span class="ruby-identifier">subcontext</span> )
303:             <span class="ruby-identifier">result</span> = <span class="ruby-identifier">result</span>[<span class="ruby-value">0</span>] <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">result</span>.<span class="ruby-identifier">kind_of?</span> <span class="ruby-constant">Array</span> <span class="ruby-keyword kw">and</span> <span class="ruby-identifier">result</span>.<span class="ruby-identifier">length</span> <span class="ruby-operator">==</span> <span class="ruby-value">1</span>
304:             <span class="ruby-comment cmt">#puts &quot;#{node.hash}) Result = #{result.inspect} (#{result.class.name})&quot;</span>
305:             <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">result</span>.<span class="ruby-identifier">kind_of?</span> <span class="ruby-constant">Numeric</span>
306:               <span class="ruby-comment cmt">#puts &quot;Adding node #{node.inspect}&quot; if result == (index+1)</span>
307:               <span class="ruby-identifier">new_nodeset</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">node</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">result</span> <span class="ruby-operator">==</span> (<span class="ruby-identifier">index</span><span class="ruby-operator">+</span><span class="ruby-value">1</span>)
308:             <span class="ruby-keyword kw">elsif</span> <span class="ruby-identifier">result</span>.<span class="ruby-identifier">instance_of?</span> <span class="ruby-constant">Array</span>
309:               <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">result</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span> <span class="ruby-keyword kw">and</span> <span class="ruby-identifier">result</span>.<span class="ruby-identifier">inject</span>(<span class="ruby-keyword kw">false</span>) {<span class="ruby-operator">|</span><span class="ruby-identifier">k</span>,<span class="ruby-identifier">s</span><span class="ruby-operator">|</span> <span class="ruby-identifier">s</span> <span class="ruby-keyword kw">or</span> <span class="ruby-identifier">k</span>}
310:                 <span class="ruby-comment cmt">#puts &quot;Adding node #{node.inspect}&quot; if result.size &gt; 0</span>
311:                 <span class="ruby-identifier">new_nodeset</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">node</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">result</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>
312:               <span class="ruby-keyword kw">end</span>
313:             <span class="ruby-keyword kw">else</span>
314:               <span class="ruby-comment cmt">#puts &quot;Adding node #{node.inspect}&quot; if result</span>
315:               <span class="ruby-identifier">new_nodeset</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">node</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">result</span>
316:             <span class="ruby-keyword kw">end</span>
317:           }
318:           <span class="ruby-comment cmt">#puts &quot;New nodeset = #{new_nodeset.inspect}&quot;</span>
319:           <span class="ruby-comment cmt">#puts &quot;Path_stack  = #{path_stack.inspect}&quot;</span>
320:           <span class="ruby-identifier">nodeset</span> = <span class="ruby-identifier">new_nodeset</span>
321: ??
322: 
323:         <span class="ruby-keyword kw">when</span> <span class="ruby-identifier">:descendant_or_self</span>
324:           <span class="ruby-identifier">rv</span> = <span class="ruby-identifier">descendant_or_self</span>( <span class="ruby-identifier">path_stack</span>, <span class="ruby-identifier">nodeset</span> )
325:           <span class="ruby-identifier">path_stack</span>.<span class="ruby-identifier">clear</span>
326:           <span class="ruby-identifier">nodeset</span> = <span class="ruby-identifier">rv</span>
327:           <span class="ruby-identifier">node_types</span> = <span class="ruby-constant">ELEMENTS</span>
328: 
329:         <span class="ruby-keyword kw">when</span> <span class="ruby-identifier">:descendant</span>
330:           <span class="ruby-identifier">results</span> = []
331:           <span class="ruby-identifier">nt</span> = <span class="ruby-keyword kw">nil</span>
332:           <span class="ruby-identifier">nodeset</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">node</span><span class="ruby-operator">|</span>
333:             <span class="ruby-identifier">nt</span> = <span class="ruby-identifier">node</span>.<span class="ruby-identifier">node_type</span>
334:             <span class="ruby-identifier">results</span> <span class="ruby-operator">+=</span> <span class="ruby-identifier">expr</span>( <span class="ruby-identifier">path_stack</span>.<span class="ruby-identifier">dclone</span>.<span class="ruby-identifier">unshift</span>( <span class="ruby-identifier">:descendant_or_self</span> ),
335:               <span class="ruby-identifier">node</span>.<span class="ruby-identifier">children</span> ) <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">nt</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">:element</span> <span class="ruby-keyword kw">or</span> <span class="ruby-identifier">nt</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">:document</span>
336:           <span class="ruby-keyword kw">end</span>
337:           <span class="ruby-identifier">nodeset</span> = <span class="ruby-identifier">results</span>
338:           <span class="ruby-identifier">node_types</span> = <span class="ruby-constant">ELEMENTS</span>
339: 
340:         <span class="ruby-keyword kw">when</span> <span class="ruby-identifier">:following_sibling</span>
341:           <span class="ruby-comment cmt">#puts &quot;FOLLOWING_SIBLING 1: nodeset = #{nodeset}&quot;</span>
342:           <span class="ruby-identifier">results</span> = []
343:           <span class="ruby-identifier">nodeset</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">node</span><span class="ruby-operator">|</span>
344:             <span class="ruby-keyword kw">next</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">node</span>.<span class="ruby-identifier">parent</span>.<span class="ruby-identifier">nil?</span>
345:             <span class="ruby-identifier">all_siblings</span> = <span class="ruby-identifier">node</span>.<span class="ruby-identifier">parent</span>.<span class="ruby-identifier">children</span>
346:             <span class="ruby-identifier">current_index</span> = <span class="ruby-identifier">all_siblings</span>.<span class="ruby-identifier">index</span>( <span class="ruby-identifier">node</span> )
347:             <span class="ruby-identifier">following_siblings</span> = <span class="ruby-identifier">all_siblings</span>[ <span class="ruby-identifier">current_index</span><span class="ruby-operator">+</span><span class="ruby-value">1</span> <span class="ruby-operator">..</span> <span class="ruby-value">-1</span> ]
348:             <span class="ruby-identifier">results</span> <span class="ruby-operator">+=</span> <span class="ruby-identifier">expr</span>( <span class="ruby-identifier">path_stack</span>.<span class="ruby-identifier">dclone</span>, <span class="ruby-identifier">following_siblings</span> )
349:           <span class="ruby-keyword kw">end</span>
350:           <span class="ruby-comment cmt">#puts &quot;FOLLOWING_SIBLING 2: nodeset = #{nodeset}&quot;</span>
351:           <span class="ruby-identifier">nodeset</span> = <span class="ruby-identifier">results</span>
352: 
353:         <span class="ruby-keyword kw">when</span> <span class="ruby-identifier">:preceding_sibling</span>
354:           <span class="ruby-identifier">results</span> = []
355:           <span class="ruby-identifier">nodeset</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">node</span><span class="ruby-operator">|</span>
356:             <span class="ruby-keyword kw">next</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">node</span>.<span class="ruby-identifier">parent</span>.<span class="ruby-identifier">nil?</span>
357:             <span class="ruby-identifier">all_siblings</span> = <span class="ruby-identifier">node</span>.<span class="ruby-identifier">parent</span>.<span class="ruby-identifier">children</span>
358:             <span class="ruby-identifier">current_index</span> = <span class="ruby-identifier">all_siblings</span>.<span class="ruby-identifier">index</span>( <span class="ruby-identifier">node</span> )
359:             <span class="ruby-identifier">preceding_siblings</span> = <span class="ruby-identifier">all_siblings</span>[ <span class="ruby-value">0</span>, <span class="ruby-identifier">current_index</span> ].<span class="ruby-identifier">reverse</span>
360:             <span class="ruby-identifier">results</span> <span class="ruby-operator">+=</span> <span class="ruby-identifier">preceding_siblings</span>
361:           <span class="ruby-keyword kw">end</span>
362:           <span class="ruby-identifier">nodeset</span> = <span class="ruby-identifier">results</span>
363:           <span class="ruby-identifier">node_types</span> = <span class="ruby-constant">ELEMENTS</span>
364: 
365:         <span class="ruby-keyword kw">when</span> <span class="ruby-identifier">:preceding</span>
366:           <span class="ruby-identifier">new_nodeset</span> = []
367:           <span class="ruby-identifier">nodeset</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">node</span><span class="ruby-operator">|</span>
368:             <span class="ruby-identifier">new_nodeset</span> <span class="ruby-operator">+=</span> <span class="ruby-identifier">preceding</span>( <span class="ruby-identifier">node</span> )
369:           <span class="ruby-keyword kw">end</span>
370:           <span class="ruby-comment cmt">#puts &quot;NEW NODESET =&gt; #{new_nodeset.inspect}&quot;</span>
371:           <span class="ruby-identifier">nodeset</span> = <span class="ruby-identifier">new_nodeset</span>
372:           <span class="ruby-identifier">node_types</span> = <span class="ruby-constant">ELEMENTS</span>
373: 
374:         <span class="ruby-keyword kw">when</span> <span class="ruby-identifier">:following</span>
375:           <span class="ruby-identifier">new_nodeset</span> = []
376:           <span class="ruby-identifier">nodeset</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">node</span><span class="ruby-operator">|</span>
377:             <span class="ruby-identifier">new_nodeset</span> <span class="ruby-operator">+=</span> <span class="ruby-identifier">following</span>( <span class="ruby-identifier">node</span> )
378:           <span class="ruby-keyword kw">end</span>
379:           <span class="ruby-identifier">nodeset</span> = <span class="ruby-identifier">new_nodeset</span>
380:           <span class="ruby-identifier">node_types</span> = <span class="ruby-constant">ELEMENTS</span>
381: 
382:         <span class="ruby-keyword kw">when</span> <span class="ruby-identifier">:namespace</span>
383:           <span class="ruby-comment cmt">#puts &quot;In :namespace&quot;</span>
384:           <span class="ruby-identifier">new_nodeset</span> = []
385:           <span class="ruby-identifier">prefix</span> = <span class="ruby-identifier">path_stack</span>.<span class="ruby-identifier">shift</span>
386:           <span class="ruby-identifier">nodeset</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">node</span><span class="ruby-operator">|</span>
387:             <span class="ruby-keyword kw">if</span> (<span class="ruby-identifier">node</span>.<span class="ruby-identifier">node_type</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">:element</span> <span class="ruby-keyword kw">or</span> <span class="ruby-identifier">node</span>.<span class="ruby-identifier">node_type</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">:attribute</span>)
388:               <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@namespaces</span>
389:                 <span class="ruby-identifier">namespaces</span> = <span class="ruby-ivar">@namespaces</span>
390:               <span class="ruby-keyword kw">elsif</span> (<span class="ruby-identifier">node</span>.<span class="ruby-identifier">node_type</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">:element</span>)
391:                 <span class="ruby-identifier">namespaces</span> = <span class="ruby-identifier">node</span>.<span class="ruby-identifier">namespaces</span>
392:               <span class="ruby-keyword kw">else</span>
393:                 <span class="ruby-identifier">namespaces</span> = <span class="ruby-identifier">node</span>.<span class="ruby-identifier">element</span>.<span class="ruby-identifier">namesapces</span>
394:               <span class="ruby-keyword kw">end</span>
395:               <span class="ruby-comment cmt">#puts &quot;Namespaces = #{namespaces.inspect}&quot;</span>
396:               <span class="ruby-comment cmt">#puts &quot;Prefix = #{prefix.inspect}&quot;</span>
397:               <span class="ruby-comment cmt">#puts &quot;Node.namespace = #{node.namespace}&quot;</span>
398:               <span class="ruby-keyword kw">if</span> (<span class="ruby-identifier">node</span>.<span class="ruby-identifier">namespace</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">namespaces</span>[<span class="ruby-identifier">prefix</span>])
399:                 <span class="ruby-identifier">new_nodeset</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">node</span>
400:               <span class="ruby-keyword kw">end</span>
401:             <span class="ruby-keyword kw">end</span>
402:           <span class="ruby-keyword kw">end</span>
403:           <span class="ruby-identifier">nodeset</span> = <span class="ruby-identifier">new_nodeset</span>
404: 
405:         <span class="ruby-keyword kw">when</span> <span class="ruby-identifier">:variable</span>
406:           <span class="ruby-identifier">var_name</span> = <span class="ruby-identifier">path_stack</span>.<span class="ruby-identifier">shift</span>
407:           <span class="ruby-keyword kw">return</span> <span class="ruby-ivar">@variables</span>[ <span class="ruby-identifier">var_name</span> ]
408: 
409:         <span class="ruby-comment cmt"># :and, :or, :eq, :neq, :lt, :lteq, :gt, :gteq</span>
410:         <span class="ruby-comment cmt"># TODO: Special case for :or and :and -- not evaluate the right</span>
411:         <span class="ruby-comment cmt"># operand if the left alone determines result (i.e. is true for</span>
412:         <span class="ruby-comment cmt"># :or and false for :and).</span>
413:         <span class="ruby-keyword kw">when</span> <span class="ruby-identifier">:eq</span>, <span class="ruby-identifier">:neq</span>, <span class="ruby-identifier">:lt</span>, <span class="ruby-identifier">:lteq</span>, <span class="ruby-identifier">:gt</span>, <span class="ruby-identifier">:gteq</span>, <span class="ruby-identifier">:or</span>
414:           <span class="ruby-identifier">left</span> = <span class="ruby-identifier">expr</span>( <span class="ruby-identifier">path_stack</span>.<span class="ruby-identifier">shift</span>, <span class="ruby-identifier">nodeset</span>.<span class="ruby-identifier">dup</span>, <span class="ruby-identifier">context</span> )
415:           <span class="ruby-comment cmt">#puts &quot;LEFT =&gt; #{left.inspect} (#{left.class.name})&quot;</span>
416:           <span class="ruby-identifier">right</span> = <span class="ruby-identifier">expr</span>( <span class="ruby-identifier">path_stack</span>.<span class="ruby-identifier">shift</span>, <span class="ruby-identifier">nodeset</span>.<span class="ruby-identifier">dup</span>, <span class="ruby-identifier">context</span> )
417:           <span class="ruby-comment cmt">#puts &quot;RIGHT =&gt; #{right.inspect} (#{right.class.name})&quot;</span>
418:           <span class="ruby-identifier">res</span> = <span class="ruby-identifier">equality_relational_compare</span>( <span class="ruby-identifier">left</span>, <span class="ruby-identifier">op</span>, <span class="ruby-identifier">right</span> )
419:           <span class="ruby-comment cmt">#puts &quot;RES =&gt; #{res.inspect}&quot;</span>
420:           <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">res</span>
421: 
422:         <span class="ruby-keyword kw">when</span> <span class="ruby-identifier">:and</span>
423:           <span class="ruby-identifier">left</span> = <span class="ruby-identifier">expr</span>( <span class="ruby-identifier">path_stack</span>.<span class="ruby-identifier">shift</span>, <span class="ruby-identifier">nodeset</span>.<span class="ruby-identifier">dup</span>, <span class="ruby-identifier">context</span> )
424:           <span class="ruby-comment cmt">#puts &quot;LEFT =&gt; #{left.inspect} (#{left.class.name})&quot;</span>
425:           <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">left</span> <span class="ruby-operator">==</span> <span class="ruby-keyword kw">false</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">left</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-operator">||</span> <span class="ruby-operator">!</span><span class="ruby-identifier">left</span>.<span class="ruby-identifier">inject</span>(<span class="ruby-keyword kw">false</span>) {<span class="ruby-operator">|</span><span class="ruby-identifier">a</span>,<span class="ruby-identifier">b</span><span class="ruby-operator">|</span> <span class="ruby-identifier">a</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">b</span>}
426:             <span class="ruby-keyword kw">return</span> []
427:           <span class="ruby-keyword kw">end</span>
428:           <span class="ruby-identifier">right</span> = <span class="ruby-identifier">expr</span>( <span class="ruby-identifier">path_stack</span>.<span class="ruby-identifier">shift</span>, <span class="ruby-identifier">nodeset</span>.<span class="ruby-identifier">dup</span>, <span class="ruby-identifier">context</span> )
429:           <span class="ruby-comment cmt">#puts &quot;RIGHT =&gt; #{right.inspect} (#{right.class.name})&quot;</span>
430:           <span class="ruby-identifier">res</span> = <span class="ruby-identifier">equality_relational_compare</span>( <span class="ruby-identifier">left</span>, <span class="ruby-identifier">op</span>, <span class="ruby-identifier">right</span> )
431:           <span class="ruby-comment cmt">#puts &quot;RES =&gt; #{res.inspect}&quot;</span>
432:           <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">res</span>
433: 
434:         <span class="ruby-keyword kw">when</span> <span class="ruby-identifier">:div</span>
435:           <span class="ruby-identifier">left</span> = <span class="ruby-constant">Functions</span><span class="ruby-operator">::</span><span class="ruby-identifier">number</span>(<span class="ruby-identifier">expr</span>(<span class="ruby-identifier">path_stack</span>.<span class="ruby-identifier">shift</span>, <span class="ruby-identifier">nodeset</span>, <span class="ruby-identifier">context</span>)).<span class="ruby-identifier">to_f</span>
436:           <span class="ruby-identifier">right</span> = <span class="ruby-constant">Functions</span><span class="ruby-operator">::</span><span class="ruby-identifier">number</span>(<span class="ruby-identifier">expr</span>(<span class="ruby-identifier">path_stack</span>.<span class="ruby-identifier">shift</span>, <span class="ruby-identifier">nodeset</span>, <span class="ruby-identifier">context</span>)).<span class="ruby-identifier">to_f</span>
437:           <span class="ruby-keyword kw">return</span> (<span class="ruby-identifier">left</span> <span class="ruby-operator">/</span> <span class="ruby-identifier">right</span>)
438: 
439:         <span class="ruby-keyword kw">when</span> <span class="ruby-identifier">:mod</span>
440:           <span class="ruby-identifier">left</span> = <span class="ruby-constant">Functions</span><span class="ruby-operator">::</span><span class="ruby-identifier">number</span>(<span class="ruby-identifier">expr</span>(<span class="ruby-identifier">path_stack</span>.<span class="ruby-identifier">shift</span>, <span class="ruby-identifier">nodeset</span>, <span class="ruby-identifier">context</span> )).<span class="ruby-identifier">to_f</span>
441:           <span class="ruby-identifier">right</span> = <span class="ruby-constant">Functions</span><span class="ruby-operator">::</span><span class="ruby-identifier">number</span>(<span class="ruby-identifier">expr</span>(<span class="ruby-identifier">path_stack</span>.<span class="ruby-identifier">shift</span>, <span class="ruby-identifier">nodeset</span>, <span class="ruby-identifier">context</span> )).<span class="ruby-identifier">to_f</span>
442:           <span class="ruby-keyword kw">return</span> (<span class="ruby-identifier">left</span> <span class="ruby-operator">%</span> <span class="ruby-identifier">right</span>)
443: 
444:         <span class="ruby-keyword kw">when</span> <span class="ruby-identifier">:mult</span>
445:           <span class="ruby-identifier">left</span> = <span class="ruby-constant">Functions</span><span class="ruby-operator">::</span><span class="ruby-identifier">number</span>(<span class="ruby-identifier">expr</span>(<span class="ruby-identifier">path_stack</span>.<span class="ruby-identifier">shift</span>, <span class="ruby-identifier">nodeset</span>, <span class="ruby-identifier">context</span> )).<span class="ruby-identifier">to_f</span>
446:           <span class="ruby-identifier">right</span> = <span class="ruby-constant">Functions</span><span class="ruby-operator">::</span><span class="ruby-identifier">number</span>(<span class="ruby-identifier">expr</span>(<span class="ruby-identifier">path_stack</span>.<span class="ruby-identifier">shift</span>, <span class="ruby-identifier">nodeset</span>, <span class="ruby-identifier">context</span> )).<span class="ruby-identifier">to_f</span>
447:           <span class="ruby-keyword kw">return</span> (<span class="ruby-identifier">left</span> <span class="ruby-operator">*</span> <span class="ruby-identifier">right</span>)
448: 
449:         <span class="ruby-keyword kw">when</span> <span class="ruby-identifier">:plus</span>
450:           <span class="ruby-identifier">left</span> = <span class="ruby-constant">Functions</span><span class="ruby-operator">::</span><span class="ruby-identifier">number</span>(<span class="ruby-identifier">expr</span>(<span class="ruby-identifier">path_stack</span>.<span class="ruby-identifier">shift</span>, <span class="ruby-identifier">nodeset</span>, <span class="ruby-identifier">context</span> )).<span class="ruby-identifier">to_f</span>
451:           <span class="ruby-identifier">right</span> = <span class="ruby-constant">Functions</span><span class="ruby-operator">::</span><span class="ruby-identifier">number</span>(<span class="ruby-identifier">expr</span>(<span class="ruby-identifier">path_stack</span>.<span class="ruby-identifier">shift</span>, <span class="ruby-identifier">nodeset</span>, <span class="ruby-identifier">context</span> )).<span class="ruby-identifier">to_f</span>
452:           <span class="ruby-keyword kw">return</span> (<span class="ruby-identifier">left</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">right</span>)
453: 
454:         <span class="ruby-keyword kw">when</span> <span class="ruby-identifier">:minus</span>
455:           <span class="ruby-identifier">left</span> = <span class="ruby-constant">Functions</span><span class="ruby-operator">::</span><span class="ruby-identifier">number</span>(<span class="ruby-identifier">expr</span>(<span class="ruby-identifier">path_stack</span>.<span class="ruby-identifier">shift</span>, <span class="ruby-identifier">nodeset</span>, <span class="ruby-identifier">context</span> )).<span class="ruby-identifier">to_f</span>
456:           <span class="ruby-identifier">right</span> = <span class="ruby-constant">Functions</span><span class="ruby-operator">::</span><span class="ruby-identifier">number</span>(<span class="ruby-identifier">expr</span>(<span class="ruby-identifier">path_stack</span>.<span class="ruby-identifier">shift</span>, <span class="ruby-identifier">nodeset</span>, <span class="ruby-identifier">context</span> )).<span class="ruby-identifier">to_f</span>
457:           <span class="ruby-keyword kw">return</span> (<span class="ruby-identifier">left</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">right</span>)
458: 
459:         <span class="ruby-keyword kw">when</span> <span class="ruby-identifier">:union</span>
460:           <span class="ruby-identifier">left</span> = <span class="ruby-identifier">expr</span>( <span class="ruby-identifier">path_stack</span>.<span class="ruby-identifier">shift</span>, <span class="ruby-identifier">nodeset</span>, <span class="ruby-identifier">context</span> )
461:           <span class="ruby-identifier">right</span> = <span class="ruby-identifier">expr</span>( <span class="ruby-identifier">path_stack</span>.<span class="ruby-identifier">shift</span>, <span class="ruby-identifier">nodeset</span>, <span class="ruby-identifier">context</span> )
462:           <span class="ruby-keyword kw">return</span> (<span class="ruby-identifier">left</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">right</span>)
463: 
464:         <span class="ruby-keyword kw">when</span> <span class="ruby-identifier">:neg</span>
465:           <span class="ruby-identifier">res</span> = <span class="ruby-identifier">expr</span>( <span class="ruby-identifier">path_stack</span>, <span class="ruby-identifier">nodeset</span>, <span class="ruby-identifier">context</span> )
466:           <span class="ruby-keyword kw">return</span> <span class="ruby-operator">-</span>(<span class="ruby-identifier">res</span>.<span class="ruby-identifier">to_f</span>)
467: 
468:         <span class="ruby-keyword kw">when</span> <span class="ruby-identifier">:not</span>
469:         <span class="ruby-keyword kw">when</span> <span class="ruby-identifier">:function</span>
470:           <span class="ruby-identifier">func_name</span> = <span class="ruby-identifier">path_stack</span>.<span class="ruby-identifier">shift</span>.<span class="ruby-identifier">tr</span>(<span class="ruby-value str">'-'</span>,<span class="ruby-value str">'_'</span>)
471:           <span class="ruby-identifier">arguments</span> = <span class="ruby-identifier">path_stack</span>.<span class="ruby-identifier">shift</span>
472:           <span class="ruby-comment cmt">#puts &quot;FUNCTION 0: #{func_name}(#{arguments.collect{|a|a.inspect}.join(', ')})&quot; </span>
473:           <span class="ruby-identifier">subcontext</span> = <span class="ruby-identifier">context</span> <span class="ruby-value">? </span><span class="ruby-keyword kw">nil</span> <span class="ruby-operator">:</span> { <span class="ruby-identifier">:size</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">nodeset</span>.<span class="ruby-identifier">size</span> }
474: 
475:           <span class="ruby-identifier">res</span> = []
476:           <span class="ruby-identifier">cont</span> = <span class="ruby-identifier">context</span>
477:           <span class="ruby-identifier">nodeset</span>.<span class="ruby-identifier">each_with_index</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">n</span>, <span class="ruby-identifier">i</span><span class="ruby-operator">|</span> 
478:             <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">subcontext</span>
479:               <span class="ruby-identifier">subcontext</span>[<span class="ruby-identifier">:node</span>]  = <span class="ruby-identifier">n</span>
480:               <span class="ruby-identifier">subcontext</span>[<span class="ruby-identifier">:index</span>] = <span class="ruby-identifier">i</span>
481:               <span class="ruby-identifier">cont</span> = <span class="ruby-identifier">subcontext</span>
482:             <span class="ruby-keyword kw">end</span>
483:             <span class="ruby-identifier">arg_clone</span> = <span class="ruby-identifier">arguments</span>.<span class="ruby-identifier">dclone</span>
484:             <span class="ruby-identifier">args</span> = <span class="ruby-identifier">arg_clone</span>.<span class="ruby-identifier">collect</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">arg</span><span class="ruby-operator">|</span> 
485:               <span class="ruby-comment cmt">#puts &quot;FUNCTION 1: Calling expr( #{arg.inspect}, [#{n.inspect}] )&quot;</span>
486:               <span class="ruby-identifier">expr</span>( <span class="ruby-identifier">arg</span>, [<span class="ruby-identifier">n</span>], <span class="ruby-identifier">cont</span> ) 
487:             }
488:             <span class="ruby-comment cmt">#puts &quot;FUNCTION 2: #{func_name}(#{args.collect{|a|a.inspect}.join(', ')})&quot; </span>
489:             <span class="ruby-constant">Functions</span>.<span class="ruby-identifier">context</span> = <span class="ruby-identifier">cont</span>
490:             <span class="ruby-identifier">res</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-constant">Functions</span>.<span class="ruby-identifier">send</span>( <span class="ruby-identifier">func_name</span>, <span class="ruby-operator">*</span><span class="ruby-identifier">args</span> )
491:             <span class="ruby-comment cmt">#puts &quot;FUNCTION 3: #{res[-1].inspect}&quot;</span>
492:           }
493:           <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">res</span>
494: 
495:         <span class="ruby-keyword kw">end</span>
496:       <span class="ruby-keyword kw">end</span> <span class="ruby-comment cmt"># while</span>
497:       <span class="ruby-comment cmt">#puts &quot;EXPR returning #{nodeset.inspect}&quot;</span>
498:       <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">nodeset</span>
499:     <span class="ruby-keyword kw">end</span></pre>
</body>
</html>
