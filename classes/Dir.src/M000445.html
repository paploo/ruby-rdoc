<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
  <title>new (Dir)</title>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <link rel="stylesheet" href="../.././rdoc-style.css" type="text/css" media="screen" />
</head>
<body class="standalone-code">
  <pre>/*
 *  call-seq:
 *     Dir.new( string ) -&gt; aDir
 *
 *  Returns a new directory object for the named directory.
 */
static VALUE
dir_initialize(int argc, VALUE *argv, VALUE dir)
{
    struct dir_data *dp;
    rb_encoding  *fsenc;
    VALUE dirname, opt;
    static VALUE sym_enc;

    if (!sym_enc) {
        sym_enc = ID2SYM(rb_intern(&quot;encoding&quot;));
    }
    fsenc = rb_filesystem_encoding();

    rb_scan_args(argc, argv, &quot;11&quot;, &amp;dirname, &amp;opt);

    if (!NIL_P(opt)) {
        VALUE v, enc=Qnil;
        opt = rb_convert_type(opt, T_HASH, &quot;Hash&quot;, &quot;to_hash&quot;);

        v = rb_hash_aref(opt, sym_enc);
        if (!NIL_P(v)) enc = v;

        if (!NIL_P(enc)) {
            fsenc = rb_to_encoding(enc);
        }
    }

    FilePathValue(dirname);

    Data_Get_Struct(dir, struct dir_data, dp);
    if (dp-&gt;dir) closedir(dp-&gt;dir);
    dp-&gt;dir = NULL;
    dp-&gt;path = Qnil;
    dp-&gt;enc = fsenc;
    dp-&gt;dir = opendir(RSTRING_PTR(dirname));
    if (dp-&gt;dir == NULL) {
        if (errno == EMFILE || errno == ENFILE) {
            rb_gc();
            dp-&gt;dir = opendir(RSTRING_PTR(dirname));
        }
        if (dp-&gt;dir == NULL) {
            rb_sys_fail(RSTRING_PTR(dirname));
        }
    }
    dp-&gt;path = rb_str_dup_frozen(dirname);

    return dir;
}</pre>
</body>
</html>
