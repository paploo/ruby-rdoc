<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
  <title>new (WIN32OLE_TYPELIB)</title>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <link rel="stylesheet" href="../.././rdoc-style.css" type="text/css" media="screen" />
</head>
<body class="standalone-code">
  <pre>/*
 * call-seq:
 *    WIN32OLE_TYPELIB.new(typelib [, version1, version2]) -&gt; WIN32OLE_TYPELIB object
 *
 * Returns a new WIN32OLE_TYPELIB object.
 *
 * The first argument &lt;i&gt;typelib&lt;/i&gt;  specifies OLE type library name or GUID or 
 * OLE library file.
 * The second argument is major version or version of the type library.
 * The third argument is minor version.
 * The second argument and third argument are optional.
 * If the first argument is type library name, then the second and third argument
 * are ignored.
 *
 *     tlib1 = WIN32OLE_TYPELIB.new('Microsoft Excel 9.0 Object Library') 
 *     tlib2 = WIN32OLE_TYPELIB.new('{00020813-0000-0000-C000-000000000046}')
 *     tlib3 = WIN32OLE_TYPELIB.new('{00020813-0000-0000-C000-000000000046}', 1.3)
 *     tlib4 = WIN32OLE_TYPELIB.new('{00020813-0000-0000-C000-000000000046}', 1, 3)
 *     tlib5 = WIN32OLE_TYPELIB.new(&quot;C:\\WINNT\\SYSTEM32\\SHELL32.DLL&quot;)
 *     puts tlib1.name  # -&gt; 'Microsoft Excel 9.0 Object Library'
 *     puts tlib2.name  # -&gt; 'Microsoft Excel 9.0 Object Library'
 *     puts tlib3.name  # -&gt; 'Microsoft Excel 9.0 Object Library'
 *     puts tlib4.name  # -&gt; 'Microsoft Excel 9.0 Object Library'
 *     puts tlib5.name  # -&gt; 'Microsoft Shell Controls And Automation'
 *
 */
static VALUE
foletypelib_initialize(VALUE self, VALUE args)
{
    VALUE found = Qfalse;
    VALUE typelib = Qnil;
    int len = 0;
    OLECHAR * pbuf;
    ITypeLib *pTypeLib;
    VALUE retval;
    HRESULT hr = S_OK;

    len = RARRAY_LEN(args);
    if (len &lt; 1 || len &gt; 3) {
        rb_raise(rb_eArgError, &quot;wrong number of arguments (%d for 1..3)&quot;, len);
    }

    typelib = rb_ary_entry(args, 0);

    Check_SafeStr(typelib);

    found = oletypelib_search_registry(self, typelib);
    if (found == Qfalse) {
        found = oletypelib_search_registry2(self, args);
    }
    if (found == Qfalse) {
        pbuf = ole_vstr2wc(typelib);
        hr = LoadTypeLibEx(pbuf, REGKIND_NONE, &amp;pTypeLib);
        SysFreeString(pbuf);
        if (SUCCEEDED(hr)) {
            retval = ole_typelib_from_itypelib(pTypeLib);
            OLE_RELEASE(pTypeLib);
            if (retval != Qnil) {
                found = Qtrue;
                oletypelib_set_member(self, 
                        rb_ivar_get(retval, rb_intern(&quot;name&quot;)),
                        rb_ivar_get(retval, rb_intern(&quot;guid&quot;)),
                        rb_ivar_get(retval, rb_intern(&quot;version&quot;)));
            }
        }
    }

    if (found == Qfalse) {
        rb_raise(eWIN32OLERuntimeError, &quot;not found type library `%s`&quot;,
                 StringValuePtr(typelib));
    }
    return self;
}</pre>
</body>
</html>
