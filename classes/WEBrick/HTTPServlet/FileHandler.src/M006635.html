<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
  <title>set_dir_list (WEBrick::HTTPServlet::FileHandler)</title>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <link rel="stylesheet" href="../../../.././rdoc-style.css" type="text/css" media="screen" />
</head>
<body class="standalone-code">
  <pre>     <span class="ruby-comment cmt"># File lib/webrick/httpservlet/filehandler.rb, line 356</span>
356:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">set_dir_list</span>(<span class="ruby-identifier">req</span>, <span class="ruby-identifier">res</span>)
357:         <span class="ruby-identifier">redirect_to_directory_uri</span>(<span class="ruby-identifier">req</span>, <span class="ruby-identifier">res</span>)
358:         <span class="ruby-keyword kw">unless</span> <span class="ruby-ivar">@options</span>[<span class="ruby-identifier">:FancyIndexing</span>]
359:           <span class="ruby-identifier">raise</span> <span class="ruby-constant">HTTPStatus</span><span class="ruby-operator">::</span><span class="ruby-constant">Forbidden</span>, <span class="ruby-node">&quot;no access permission to `#{req.path}'&quot;</span>
360:         <span class="ruby-keyword kw">end</span>
361:         <span class="ruby-identifier">local_path</span> = <span class="ruby-identifier">res</span>.<span class="ruby-identifier">filename</span>
362:         <span class="ruby-identifier">list</span> = <span class="ruby-constant">Dir</span><span class="ruby-operator">::</span><span class="ruby-identifier">entries</span>(<span class="ruby-identifier">local_path</span>).<span class="ruby-identifier">collect</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">name</span><span class="ruby-operator">|</span>
363:           <span class="ruby-keyword kw">next</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">name</span> <span class="ruby-operator">==</span> <span class="ruby-value str">&quot;.&quot;</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">name</span> <span class="ruby-operator">==</span> <span class="ruby-value str">&quot;..&quot;</span>
364:           <span class="ruby-keyword kw">next</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">nondisclosure_name?</span>(<span class="ruby-identifier">name</span>)
365:           <span class="ruby-keyword kw">next</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">windows_ambiguous_name?</span>(<span class="ruby-identifier">name</span>)
366:           <span class="ruby-identifier">st</span> = (<span class="ruby-constant">File</span><span class="ruby-operator">::</span><span class="ruby-identifier">stat</span>(<span class="ruby-constant">File</span>.<span class="ruby-identifier">join</span>(<span class="ruby-identifier">local_path</span>, <span class="ruby-identifier">name</span>)) <span class="ruby-keyword kw">rescue</span> <span class="ruby-keyword kw">nil</span>)
367:           <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">st</span>.<span class="ruby-identifier">nil?</span>
368:             [ <span class="ruby-identifier">name</span>, <span class="ruby-keyword kw">nil</span>, <span class="ruby-value">-1</span> ]
369:           <span class="ruby-keyword kw">elsif</span> <span class="ruby-identifier">st</span>.<span class="ruby-identifier">directory?</span>
370:             [ <span class="ruby-identifier">name</span> <span class="ruby-operator">+</span> <span class="ruby-value str">&quot;/&quot;</span>, <span class="ruby-identifier">st</span>.<span class="ruby-identifier">mtime</span>, <span class="ruby-value">-1</span> ]
371:           <span class="ruby-keyword kw">else</span>
372:             [ <span class="ruby-identifier">name</span>, <span class="ruby-identifier">st</span>.<span class="ruby-identifier">mtime</span>, <span class="ruby-identifier">st</span>.<span class="ruby-identifier">size</span> ]
373:           <span class="ruby-keyword kw">end</span>
374:         }
375:         <span class="ruby-identifier">list</span>.<span class="ruby-identifier">compact!</span>
376: 
377:         <span class="ruby-keyword kw">if</span>    <span class="ruby-identifier">d0</span> = <span class="ruby-identifier">req</span>.<span class="ruby-identifier">query</span>[<span class="ruby-value str">&quot;N&quot;</span>]; <span class="ruby-identifier">idx</span> = <span class="ruby-value">0</span>
378:         <span class="ruby-keyword kw">elsif</span> <span class="ruby-identifier">d0</span> = <span class="ruby-identifier">req</span>.<span class="ruby-identifier">query</span>[<span class="ruby-value str">&quot;M&quot;</span>]; <span class="ruby-identifier">idx</span> = <span class="ruby-value">1</span>
379:         <span class="ruby-keyword kw">elsif</span> <span class="ruby-identifier">d0</span> = <span class="ruby-identifier">req</span>.<span class="ruby-identifier">query</span>[<span class="ruby-value str">&quot;S&quot;</span>]; <span class="ruby-identifier">idx</span> = <span class="ruby-value">2</span>
380:         <span class="ruby-keyword kw">else</span>  <span class="ruby-identifier">d0</span> = <span class="ruby-value str">&quot;A&quot;</span>           ; <span class="ruby-identifier">idx</span> = <span class="ruby-value">0</span>
381:         <span class="ruby-keyword kw">end</span>
382:         <span class="ruby-identifier">d1</span> = (<span class="ruby-identifier">d0</span> <span class="ruby-operator">==</span> <span class="ruby-value str">&quot;A&quot;</span>) <span class="ruby-operator">?</span> <span class="ruby-value str">&quot;D&quot;</span> <span class="ruby-operator">:</span> <span class="ruby-value str">&quot;A&quot;</span>
383: 
384:         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">d0</span> <span class="ruby-operator">==</span> <span class="ruby-value str">&quot;A&quot;</span>
385:           <span class="ruby-identifier">list</span>.<span class="ruby-identifier">sort!</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">a</span>,<span class="ruby-identifier">b</span><span class="ruby-operator">|</span> <span class="ruby-identifier">a</span>[<span class="ruby-identifier">idx</span>] <span class="ruby-operator">&lt;=&gt;</span> <span class="ruby-identifier">b</span>[<span class="ruby-identifier">idx</span>] }
386:         <span class="ruby-keyword kw">else</span>
387:           <span class="ruby-identifier">list</span>.<span class="ruby-identifier">sort!</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">a</span>,<span class="ruby-identifier">b</span><span class="ruby-operator">|</span> <span class="ruby-identifier">b</span>[<span class="ruby-identifier">idx</span>] <span class="ruby-operator">&lt;=&gt;</span> <span class="ruby-identifier">a</span>[<span class="ruby-identifier">idx</span>] }
388:         <span class="ruby-keyword kw">end</span>
389: 
390:         <span class="ruby-identifier">res</span>[<span class="ruby-value str">'content-type'</span>] = <span class="ruby-value str">&quot;text/html&quot;</span>
391: 
392:         <span class="ruby-identifier">res</span>.<span class="ruby-identifier">body</span> = <span class="ruby-value str">&quot;&lt;!DOCTYPE HTML PUBLIC \&quot;-//W3C//DTD HTML 3.2 Final//EN\&quot;&gt;\n&lt;HTML&gt;\n&lt;HEAD&gt;&lt;TITLE&gt;Index of \#{HTMLUtils::escape(req.path)}&lt;/TITLE&gt;&lt;/HEAD&gt;\n&lt;BODY&gt;\n&lt;H1&gt;Index of \#{HTMLUtils::escape(req.path)}&lt;/H1&gt;\n&quot;</span>
393: 
394:         <span class="ruby-identifier">res</span>.<span class="ruby-identifier">body</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value str">&quot;&lt;PRE&gt;\n&quot;</span>
395:         <span class="ruby-identifier">res</span>.<span class="ruby-identifier">body</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot; &lt;A HREF=\&quot;?N=#{d1}\&quot;&gt;Name&lt;/A&gt;                          &quot;</span>
396:         <span class="ruby-identifier">res</span>.<span class="ruby-identifier">body</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;&lt;A HREF=\&quot;?M=#{d1}\&quot;&gt;Last modified&lt;/A&gt;         &quot;</span>
397:         <span class="ruby-identifier">res</span>.<span class="ruby-identifier">body</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;&lt;A HREF=\&quot;?S=#{d1}\&quot;&gt;Size&lt;/A&gt;\n&quot;</span>
398:         <span class="ruby-identifier">res</span>.<span class="ruby-identifier">body</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value str">&quot;&lt;HR&gt;\n&quot;</span>
399:        
400:         <span class="ruby-identifier">list</span>.<span class="ruby-identifier">unshift</span> [ <span class="ruby-value str">&quot;..&quot;</span>, <span class="ruby-constant">File</span><span class="ruby-operator">::</span><span class="ruby-identifier">mtime</span>(<span class="ruby-identifier">local_path</span><span class="ruby-operator">+</span><span class="ruby-value str">&quot;/..&quot;</span>), <span class="ruby-value">-1</span> ]
401:         <span class="ruby-identifier">list</span>.<span class="ruby-identifier">each</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">name</span>, <span class="ruby-identifier">time</span>, <span class="ruby-identifier">size</span><span class="ruby-operator">|</span>
402:           <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">name</span> <span class="ruby-operator">==</span> <span class="ruby-value str">&quot;..&quot;</span>
403:             <span class="ruby-identifier">dname</span> = <span class="ruby-value str">&quot;Parent Directory&quot;</span>
404:           <span class="ruby-keyword kw">elsif</span> <span class="ruby-identifier">name</span>.<span class="ruby-identifier">bytesize</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">25</span>
405:             <span class="ruby-identifier">dname</span> = <span class="ruby-identifier">name</span>.<span class="ruby-identifier">sub</span>(<span class="ruby-regexp re">/^(.{23})(?:.*)/</span>, <span class="ruby-value str">'\1..'</span>)
406:           <span class="ruby-keyword kw">else</span>
407:             <span class="ruby-identifier">dname</span> = <span class="ruby-identifier">name</span>
408:           <span class="ruby-keyword kw">end</span>
409:           <span class="ruby-identifier">s</span> =  <span class="ruby-node">&quot; &lt;A HREF=\&quot;#{HTTPUtils::escape(name)}\&quot;&gt;#{dname}&lt;/A&gt;&quot;</span>
410:           <span class="ruby-identifier">s</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value str">&quot; &quot;</span> <span class="ruby-operator">*</span> (<span class="ruby-value">30</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">dname</span>.<span class="ruby-identifier">bytesize</span>)
411:           <span class="ruby-identifier">s</span> <span class="ruby-operator">&lt;&lt;</span> (<span class="ruby-identifier">time</span> <span class="ruby-value">? </span><span class="ruby-identifier">time</span>.<span class="ruby-identifier">strftime</span>(<span class="ruby-value str">&quot;%Y/%m/%d %H:%M      &quot;</span>) <span class="ruby-operator">:</span> <span class="ruby-value str">&quot; &quot;</span> <span class="ruby-operator">*</span> <span class="ruby-value">22</span>)
412:           <span class="ruby-identifier">s</span> <span class="ruby-operator">&lt;&lt;</span> (<span class="ruby-identifier">size</span> <span class="ruby-operator">&gt;=</span> <span class="ruby-value">0</span> <span class="ruby-operator">?</span> <span class="ruby-identifier">size</span>.<span class="ruby-identifier">to_s</span> <span class="ruby-operator">:</span> <span class="ruby-value str">&quot;-&quot;</span>) <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value str">&quot;\n&quot;</span>
413:           <span class="ruby-identifier">res</span>.<span class="ruby-identifier">body</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">s</span>
414:         }
415:         <span class="ruby-identifier">res</span>.<span class="ruby-identifier">body</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value str">&quot;&lt;/PRE&gt;&lt;HR&gt;&quot;</span>
416: 
417:         <span class="ruby-identifier">res</span>.<span class="ruby-identifier">body</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value str">&quot;&lt;ADDRESS&gt;\n\#{HTMLUtils::escape(@config[:ServerSoftware])}&lt;BR&gt;\nat \#{req.host}:\#{req.port}\n&lt;/ADDRESS&gt;\n&lt;/BODY&gt;\n&lt;/HTML&gt;\n&quot;</span>    
418:       <span class="ruby-keyword kw">end</span></pre>
</body>
</html>
