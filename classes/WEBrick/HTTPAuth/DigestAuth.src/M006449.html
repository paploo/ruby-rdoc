<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
  <title>_authenticate (WEBrick::HTTPAuth::DigestAuth)</title>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <link rel="stylesheet" href="../../../.././rdoc-style.css" type="text/css" media="screen" />
</head>
<body class="standalone-code">
  <pre>     <span class="ruby-comment cmt"># File lib/webrick/httpauth/digestauth.rb, line 102</span>
102:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">_authenticate</span>(<span class="ruby-identifier">req</span>, <span class="ruby-identifier">res</span>)
103:         <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">digest_credentials</span> = <span class="ruby-identifier">check_scheme</span>(<span class="ruby-identifier">req</span>)
104:           <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">false</span>
105:         <span class="ruby-keyword kw">end</span>
106: 
107:         <span class="ruby-identifier">auth_req</span> = <span class="ruby-identifier">split_param_value</span>(<span class="ruby-identifier">digest_credentials</span>)
108:         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">auth_req</span>[<span class="ruby-value str">'qop'</span>] <span class="ruby-operator">==</span> <span class="ruby-value str">&quot;auth&quot;</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">auth_req</span>[<span class="ruby-value str">'qop'</span>] <span class="ruby-operator">==</span> <span class="ruby-value str">&quot;auth-int&quot;</span>
109:           <span class="ruby-identifier">req_params</span> = <span class="ruby-constant">MustParams</span> <span class="ruby-operator">+</span> <span class="ruby-constant">MustParamsAuth</span>
110:         <span class="ruby-keyword kw">else</span>
111:           <span class="ruby-identifier">req_params</span> = <span class="ruby-constant">MustParams</span>
112:         <span class="ruby-keyword kw">end</span>
113:         <span class="ruby-identifier">req_params</span>.<span class="ruby-identifier">each</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">key</span><span class="ruby-operator">|</span>
114:           <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">auth_req</span>.<span class="ruby-identifier">has_key?</span>(<span class="ruby-identifier">key</span>)
115:             <span class="ruby-identifier">error</span>(<span class="ruby-value str">'%s: parameter missing. &quot;%s&quot;'</span>, <span class="ruby-identifier">auth_req</span>[<span class="ruby-value str">'username'</span>], <span class="ruby-identifier">key</span>)
116:             <span class="ruby-identifier">raise</span> <span class="ruby-constant">HTTPStatus</span><span class="ruby-operator">::</span><span class="ruby-constant">BadRequest</span>
117:           <span class="ruby-keyword kw">end</span>
118:         }
119: 
120:         <span class="ruby-keyword kw">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">check_uri</span>(<span class="ruby-identifier">req</span>, <span class="ruby-identifier">auth_req</span>)
121:           <span class="ruby-identifier">raise</span> <span class="ruby-constant">HTTPStatus</span><span class="ruby-operator">::</span><span class="ruby-constant">BadRequest</span>  
122:         <span class="ruby-keyword kw">end</span>
123: 
124:         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">auth_req</span>[<span class="ruby-value str">'realm'</span>] <span class="ruby-operator">!=</span> <span class="ruby-ivar">@realm</span>  
125:           <span class="ruby-identifier">error</span>(<span class="ruby-value str">'%s: realm unmatch. &quot;%s&quot; for &quot;%s&quot;'</span>,
126:                 <span class="ruby-identifier">auth_req</span>[<span class="ruby-value str">'username'</span>], <span class="ruby-identifier">auth_req</span>[<span class="ruby-value str">'realm'</span>], <span class="ruby-ivar">@realm</span>)
127:           <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">false</span>
128:         <span class="ruby-keyword kw">end</span>
129: 
130:         <span class="ruby-identifier">auth_req</span>[<span class="ruby-value str">'algorithm'</span>] <span class="ruby-operator">||=</span> <span class="ruby-value str">'MD5'</span> 
131:         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">auth_req</span>[<span class="ruby-value str">'algorithm'</span>] <span class="ruby-operator">!=</span> <span class="ruby-ivar">@algorithm</span> <span class="ruby-operator">&amp;&amp;</span>
132:            (<span class="ruby-ivar">@opera_hack</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">auth_req</span>[<span class="ruby-value str">'algorithm'</span>] <span class="ruby-operator">!=</span> <span class="ruby-ivar">@algorithm</span>.<span class="ruby-identifier">upcase</span>)
133:           <span class="ruby-identifier">error</span>(<span class="ruby-value str">'%s: algorithm unmatch. &quot;%s&quot; for &quot;%s&quot;'</span>,
134:                 <span class="ruby-identifier">auth_req</span>[<span class="ruby-value str">'username'</span>], <span class="ruby-identifier">auth_req</span>[<span class="ruby-value str">'algorithm'</span>], <span class="ruby-ivar">@algorithm</span>)
135:           <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">false</span>
136:         <span class="ruby-keyword kw">end</span>
137: 
138:         <span class="ruby-keyword kw">if</span> (<span class="ruby-ivar">@qop</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">auth_req</span>.<span class="ruby-identifier">has_key?</span>(<span class="ruby-value str">'qop'</span>)) <span class="ruby-operator">||</span>
139:            (<span class="ruby-ivar">@qop</span> <span class="ruby-operator">&amp;&amp;</span> (<span class="ruby-operator">!</span> <span class="ruby-ivar">@qop</span>.<span class="ruby-identifier">member?</span>(<span class="ruby-identifier">auth_req</span>[<span class="ruby-value str">'qop'</span>])))
140:           <span class="ruby-identifier">error</span>(<span class="ruby-value str">'%s: the qop is not allowed. &quot;%s&quot;'</span>,
141:                 <span class="ruby-identifier">auth_req</span>[<span class="ruby-value str">'username'</span>], <span class="ruby-identifier">auth_req</span>[<span class="ruby-value str">'qop'</span>])
142:           <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">false</span>
143:         <span class="ruby-keyword kw">end</span>
144: 
145:         <span class="ruby-identifier">password</span> = <span class="ruby-ivar">@userdb</span>.<span class="ruby-identifier">get_passwd</span>(<span class="ruby-ivar">@realm</span>, <span class="ruby-identifier">auth_req</span>[<span class="ruby-value str">'username'</span>], <span class="ruby-ivar">@reload_db</span>)
146:         <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">password</span>
147:           <span class="ruby-identifier">error</span>(<span class="ruby-value str">'%s: the user is not allowd.'</span>, <span class="ruby-identifier">auth_req</span>[<span class="ruby-value str">'username'</span>])
148:           <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">false</span>
149:         <span class="ruby-keyword kw">end</span>
150: 
151:         <span class="ruby-identifier">nonce_is_invalid</span> = <span class="ruby-keyword kw">false</span>
152:         <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@use_opaque</span>
153:           <span class="ruby-identifier">info</span>(<span class="ruby-value str">&quot;@opaque = %s&quot;</span>, <span class="ruby-ivar">@opaque</span>.<span class="ruby-identifier">inspect</span>) <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">$DEBUG</span>
154:           <span class="ruby-keyword kw">if</span> <span class="ruby-operator">!</span>(<span class="ruby-identifier">opaque</span> = <span class="ruby-identifier">auth_req</span>[<span class="ruby-value str">'opaque'</span>])
155:             <span class="ruby-identifier">error</span>(<span class="ruby-value str">'%s: opaque is not given.'</span>, <span class="ruby-identifier">auth_req</span>[<span class="ruby-value str">'username'</span>])
156:             <span class="ruby-identifier">nonce_is_invalid</span> = <span class="ruby-keyword kw">true</span>
157:           <span class="ruby-keyword kw">elsif</span> <span class="ruby-operator">!</span>(<span class="ruby-identifier">opaque_struct</span> = <span class="ruby-ivar">@opaques</span>[<span class="ruby-identifier">opaque</span>])
158:             <span class="ruby-identifier">error</span>(<span class="ruby-value str">'%s: invalid opaque is given.'</span>, <span class="ruby-identifier">auth_req</span>[<span class="ruby-value str">'username'</span>])
159:             <span class="ruby-identifier">nonce_is_invalid</span> = <span class="ruby-keyword kw">true</span>
160:           <span class="ruby-keyword kw">elsif</span> <span class="ruby-operator">!</span><span class="ruby-identifier">check_opaque</span>(<span class="ruby-identifier">opaque_struct</span>, <span class="ruby-identifier">req</span>, <span class="ruby-identifier">auth_req</span>)
161:             <span class="ruby-ivar">@opaques</span>.<span class="ruby-identifier">delete</span>(<span class="ruby-identifier">auth_req</span>[<span class="ruby-value str">'opaque'</span>])
162:             <span class="ruby-identifier">nonce_is_invalid</span> = <span class="ruby-keyword kw">true</span>
163:           <span class="ruby-keyword kw">end</span>
164:         <span class="ruby-keyword kw">elsif</span> <span class="ruby-operator">!</span><span class="ruby-identifier">check_nonce</span>(<span class="ruby-identifier">req</span>, <span class="ruby-identifier">auth_req</span>)
165:           <span class="ruby-identifier">nonce_is_invalid</span> = <span class="ruby-keyword kw">true</span>
166:         <span class="ruby-keyword kw">end</span>
167: 
168:         <span class="ruby-keyword kw">if</span> <span class="ruby-regexp re">/-sess$/</span> <span class="ruby-operator">=~</span> <span class="ruby-identifier">auth_req</span>[<span class="ruby-value str">'algorithm'</span>] <span class="ruby-operator">||</span>
169:            (<span class="ruby-ivar">@opera_hack</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-regexp re">/-SESS$/</span> <span class="ruby-operator">=~</span> <span class="ruby-identifier">auth_req</span>[<span class="ruby-value str">'algorithm'</span>])
170:           <span class="ruby-identifier">ha1</span> = <span class="ruby-identifier">hexdigest</span>(<span class="ruby-identifier">password</span>, <span class="ruby-identifier">auth_req</span>[<span class="ruby-value str">'nonce'</span>], <span class="ruby-identifier">auth_req</span>[<span class="ruby-value str">'cnonce'</span>])
171:         <span class="ruby-keyword kw">else</span>
172:           <span class="ruby-identifier">ha1</span> = <span class="ruby-identifier">password</span>
173:         <span class="ruby-keyword kw">end</span>
174: 
175:         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">auth_req</span>[<span class="ruby-value str">'qop'</span>] <span class="ruby-operator">==</span> <span class="ruby-value str">&quot;auth&quot;</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">auth_req</span>[<span class="ruby-value str">'qop'</span>] <span class="ruby-operator">==</span> <span class="ruby-keyword kw">nil</span>
176:           <span class="ruby-identifier">ha2</span> = <span class="ruby-identifier">hexdigest</span>(<span class="ruby-identifier">req</span>.<span class="ruby-identifier">request_method</span>, <span class="ruby-identifier">auth_req</span>[<span class="ruby-value str">'uri'</span>])
177:           <span class="ruby-identifier">ha2_res</span> = <span class="ruby-identifier">hexdigest</span>(<span class="ruby-value str">&quot;&quot;</span>, <span class="ruby-identifier">auth_req</span>[<span class="ruby-value str">'uri'</span>])
178:         <span class="ruby-keyword kw">elsif</span> <span class="ruby-identifier">auth_req</span>[<span class="ruby-value str">'qop'</span>] <span class="ruby-operator">==</span> <span class="ruby-value str">&quot;auth-int&quot;</span>
179:           <span class="ruby-identifier">ha2</span> = <span class="ruby-identifier">hexdigest</span>(<span class="ruby-identifier">req</span>.<span class="ruby-identifier">request_method</span>, <span class="ruby-identifier">auth_req</span>[<span class="ruby-value str">'uri'</span>],
180:                           <span class="ruby-identifier">hexdigest</span>(<span class="ruby-identifier">req</span>.<span class="ruby-identifier">body</span>))
181:           <span class="ruby-identifier">ha2_res</span> = <span class="ruby-identifier">hexdigest</span>(<span class="ruby-value str">&quot;&quot;</span>, <span class="ruby-identifier">auth_req</span>[<span class="ruby-value str">'uri'</span>], <span class="ruby-identifier">hexdigest</span>(<span class="ruby-identifier">res</span>.<span class="ruby-identifier">body</span>))
182:         <span class="ruby-keyword kw">end</span>
183: 
184:         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">auth_req</span>[<span class="ruby-value str">'qop'</span>] <span class="ruby-operator">==</span> <span class="ruby-value str">&quot;auth&quot;</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">auth_req</span>[<span class="ruby-value str">'qop'</span>] <span class="ruby-operator">==</span> <span class="ruby-value str">&quot;auth-int&quot;</span>
185:           <span class="ruby-identifier">param2</span> = [<span class="ruby-value str">'nonce'</span>, <span class="ruby-value str">'nc'</span>, <span class="ruby-value str">'cnonce'</span>, <span class="ruby-value str">'qop'</span>].<span class="ruby-identifier">map</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">key</span><span class="ruby-operator">|</span>
186:             <span class="ruby-identifier">auth_req</span>[<span class="ruby-identifier">key</span>]
187:           }.<span class="ruby-identifier">join</span>(<span class="ruby-value str">':'</span>)
188:           <span class="ruby-identifier">digest</span>     = <span class="ruby-identifier">hexdigest</span>(<span class="ruby-identifier">ha1</span>, <span class="ruby-identifier">param2</span>, <span class="ruby-identifier">ha2</span>)
189:           <span class="ruby-identifier">digest_res</span> = <span class="ruby-identifier">hexdigest</span>(<span class="ruby-identifier">ha1</span>, <span class="ruby-identifier">param2</span>, <span class="ruby-identifier">ha2_res</span>)
190:         <span class="ruby-keyword kw">else</span>
191:           <span class="ruby-identifier">digest</span>     = <span class="ruby-identifier">hexdigest</span>(<span class="ruby-identifier">ha1</span>, <span class="ruby-identifier">auth_req</span>[<span class="ruby-value str">'nonce'</span>], <span class="ruby-identifier">ha2</span>)
192:           <span class="ruby-identifier">digest_res</span> = <span class="ruby-identifier">hexdigest</span>(<span class="ruby-identifier">ha1</span>, <span class="ruby-identifier">auth_req</span>[<span class="ruby-value str">'nonce'</span>], <span class="ruby-identifier">ha2_res</span>)
193:         <span class="ruby-keyword kw">end</span>
194: 
195:         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">digest</span> <span class="ruby-operator">!=</span> <span class="ruby-identifier">auth_req</span>[<span class="ruby-value str">'response'</span>]
196:           <span class="ruby-identifier">error</span>(<span class="ruby-value str">&quot;%s: digest unmatch.&quot;</span>, <span class="ruby-identifier">auth_req</span>[<span class="ruby-value str">'username'</span>])
197:           <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">false</span>
198:         <span class="ruby-keyword kw">elsif</span> <span class="ruby-identifier">nonce_is_invalid</span>
199:           <span class="ruby-identifier">error</span>(<span class="ruby-value str">'%s: digest is valid, but nonce is not valid.'</span>,
200:                 <span class="ruby-identifier">auth_req</span>[<span class="ruby-value str">'username'</span>])
201:           <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">:nonce_is_stale</span>
202:         <span class="ruby-keyword kw">elsif</span> <span class="ruby-ivar">@use_auth_info_header</span>
203:           <span class="ruby-identifier">auth_info</span> = {
204:             <span class="ruby-value str">'nextnonce'</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">generate_next_nonce</span>(<span class="ruby-identifier">req</span>),
205:             <span class="ruby-value str">'rspauth'</span>   =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">digest_res</span>
206:           }
207:           <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@use_opaque</span>
208:             <span class="ruby-identifier">opaque_struct</span>.<span class="ruby-identifier">time</span>  = <span class="ruby-identifier">req</span>.<span class="ruby-identifier">request_time</span>
209:             <span class="ruby-identifier">opaque_struct</span>.<span class="ruby-identifier">nonce</span> = <span class="ruby-identifier">auth_info</span>[<span class="ruby-value str">'nextnonce'</span>]
210:             <span class="ruby-identifier">opaque_struct</span>.<span class="ruby-identifier">nc</span>    = <span class="ruby-value str">&quot;%08x&quot;</span> <span class="ruby-operator">%</span> (<span class="ruby-identifier">auth_req</span>[<span class="ruby-value str">'nc'</span>].<span class="ruby-identifier">hex</span> <span class="ruby-operator">+</span> <span class="ruby-value">1</span>)
211:           <span class="ruby-keyword kw">end</span>
212:           <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">auth_req</span>[<span class="ruby-value str">'qop'</span>] <span class="ruby-operator">==</span> <span class="ruby-value str">&quot;auth&quot;</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">auth_req</span>[<span class="ruby-value str">'qop'</span>] <span class="ruby-operator">==</span> <span class="ruby-value str">&quot;auth-int&quot;</span>
213:             [<span class="ruby-value str">'qop'</span>,<span class="ruby-value str">'cnonce'</span>,<span class="ruby-value str">'nc'</span>].<span class="ruby-identifier">each</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">key</span><span class="ruby-operator">|</span>
214:               <span class="ruby-identifier">auth_info</span>[<span class="ruby-identifier">key</span>] = <span class="ruby-identifier">auth_req</span>[<span class="ruby-identifier">key</span>]
215:             }
216:           <span class="ruby-keyword kw">end</span>
217:           <span class="ruby-identifier">res</span>[<span class="ruby-ivar">@resp_info_field</span>] = <span class="ruby-identifier">auth_info</span>.<span class="ruby-identifier">keys</span>.<span class="ruby-identifier">map</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">key</span><span class="ruby-operator">|</span>
218:             <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">key</span> <span class="ruby-operator">==</span> <span class="ruby-value str">'nc'</span>
219:               <span class="ruby-identifier">key</span> <span class="ruby-operator">+</span> <span class="ruby-value str">'='</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">auth_info</span>[<span class="ruby-identifier">key</span>]
220:             <span class="ruby-keyword kw">else</span>
221:               <span class="ruby-identifier">key</span> <span class="ruby-operator">+</span> <span class="ruby-value str">&quot;=&quot;</span> <span class="ruby-operator">+</span> <span class="ruby-constant">HTTPUtils</span><span class="ruby-operator">::</span><span class="ruby-identifier">quote</span>(<span class="ruby-identifier">auth_info</span>[<span class="ruby-identifier">key</span>])
222:             <span class="ruby-keyword kw">end</span>
223:           }.<span class="ruby-identifier">join</span>(<span class="ruby-value str">', '</span>)
224:         <span class="ruby-keyword kw">end</span>
225:         <span class="ruby-identifier">info</span>(<span class="ruby-value str">'%s: authentication scceeded.'</span>, <span class="ruby-identifier">auth_req</span>[<span class="ruby-value str">'username'</span>])
226:         <span class="ruby-identifier">req</span>.<span class="ruby-identifier">user</span> = <span class="ruby-identifier">auth_req</span>[<span class="ruby-value str">'username'</span>]
227:         <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">true</span>
228:       <span class="ruby-keyword kw">end</span></pre>
</body>
</html>
