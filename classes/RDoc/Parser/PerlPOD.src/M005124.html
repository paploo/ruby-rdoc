<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
  <title>scan (RDoc::Parser::PerlPOD)</title>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <link rel="stylesheet" href="../../../.././rdoc-style.css" type="text/css" media="screen" />
</head>
<body class="standalone-code">
  <pre>     <span class="ruby-comment cmt"># File lib/rdoc/parser/perl.rb, line 51</span>
 51:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">scan</span>
 52: 
 53:     <span class="ruby-ivar">@top_level</span>.<span class="ruby-identifier">comment</span> <span class="ruby-operator">||=</span> <span class="ruby-value str">&quot;&quot;</span>
 54:     <span class="ruby-identifier">state</span>=<span class="ruby-identifier">:code_blank</span>    
 55:     <span class="ruby-identifier">line_number</span> = <span class="ruby-value">0</span>
 56:     <span class="ruby-identifier">line</span> = <span class="ruby-keyword kw">nil</span>
 57: 
 58:     <span class="ruby-comment cmt"># This started out as a really long nested case statement,</span>
 59:     <span class="ruby-comment cmt"># which also led to repetitive code.  I'd like to avoid that</span>
 60:     <span class="ruby-comment cmt"># so I'm using a &quot;table&quot; instead.</span>
 61:     
 62:     <span class="ruby-comment cmt"># Firstly we need some procs to do the transition and processing</span>
 63:     <span class="ruby-comment cmt"># work.  Because these are procs they are closures, and they can</span>
 64:     <span class="ruby-comment cmt"># use variables in the local scope.</span>
 65:     <span class="ruby-comment cmt">#</span>
 66:     <span class="ruby-comment cmt"># First, the &quot;nothing to see here&quot; stuff.</span>
 67:     <span class="ruby-identifier">code_noop</span> = <span class="ruby-identifier">lambda</span> <span class="ruby-keyword kw">do</span> 
 68:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">line</span> <span class="ruby-operator">=~</span> <span class="ruby-regexp re">/^\s+$/</span>
 69:         <span class="ruby-identifier">state</span> = <span class="ruby-identifier">:code_blank</span>
 70:       <span class="ruby-keyword kw">end</span>
 71:     <span class="ruby-keyword kw">end</span>
 72: 
 73:     <span class="ruby-identifier">pod_noop</span> = <span class="ruby-identifier">lambda</span> <span class="ruby-keyword kw">do</span> 
 74:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">line</span> <span class="ruby-operator">=~</span> <span class="ruby-regexp re">/^\s+$/</span>
 75:         <span class="ruby-identifier">state</span> = <span class="ruby-identifier">:pod_blank</span>
 76:       <span class="ruby-keyword kw">end</span>
 77:       <span class="ruby-ivar">@top_level</span>.<span class="ruby-identifier">comment</span> <span class="ruby-operator">+=</span> <span class="ruby-identifier">filter</span>(<span class="ruby-identifier">line</span>)
 78:     <span class="ruby-keyword kw">end</span>
 79: 
 80:     <span class="ruby-identifier">begin_noop</span> = <span class="ruby-identifier">lambda</span> <span class="ruby-keyword kw">do</span> 
 81:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">line</span> <span class="ruby-operator">=~</span> <span class="ruby-regexp re">/^\s+$/</span>
 82:         <span class="ruby-identifier">state</span> = <span class="ruby-identifier">:begin_blank</span>
 83:       <span class="ruby-keyword kw">end</span>
 84:       <span class="ruby-ivar">@top_level</span>.<span class="ruby-identifier">comment</span> <span class="ruby-operator">+=</span> <span class="ruby-identifier">filter</span>(<span class="ruby-identifier">line</span>)
 85:     <span class="ruby-keyword kw">end</span>
 86: 
 87:     <span class="ruby-comment cmt"># Now for the blocks that process code and comments...</span>
 88: 
 89:     <span class="ruby-identifier">transit_to_pod</span> = <span class="ruby-identifier">lambda</span> <span class="ruby-keyword kw">do</span>
 90:       <span class="ruby-keyword kw">case</span> <span class="ruby-identifier">line</span>
 91:       <span class="ruby-keyword kw">when</span> <span class="ruby-regexp re">/^=(?:pod|head\d+)/</span>
 92:         <span class="ruby-identifier">state</span> = <span class="ruby-identifier">:pod_no_blank</span>
 93:         <span class="ruby-ivar">@top_level</span>.<span class="ruby-identifier">comment</span> <span class="ruby-operator">+=</span> <span class="ruby-identifier">filter</span>(<span class="ruby-identifier">line</span>)
 94:       <span class="ruby-keyword kw">when</span> <span class="ruby-regexp re">/^=over/</span>
 95:         <span class="ruby-identifier">state</span> = <span class="ruby-identifier">:over_no_blank</span>
 96:         <span class="ruby-ivar">@top_level</span>.<span class="ruby-identifier">comment</span> <span class="ruby-operator">+=</span> <span class="ruby-identifier">filter</span>(<span class="ruby-identifier">line</span>)
 97:       <span class="ruby-keyword kw">when</span> <span class="ruby-regexp re">/^=(?:begin|for)/</span>
 98:         <span class="ruby-identifier">state</span> = <span class="ruby-identifier">:begin_no_blank</span>
 99:       <span class="ruby-keyword kw">end</span>
100:     <span class="ruby-keyword kw">end</span>
101: 
102:     <span class="ruby-identifier">process_pod</span> = <span class="ruby-identifier">lambda</span> <span class="ruby-keyword kw">do</span>
103:       <span class="ruby-keyword kw">case</span> <span class="ruby-identifier">line</span>
104:       <span class="ruby-keyword kw">when</span>  <span class="ruby-regexp re">/^\s*$/</span>
105:         <span class="ruby-identifier">state</span> = <span class="ruby-identifier">:pod_blank</span>
106:         <span class="ruby-ivar">@top_level</span>.<span class="ruby-identifier">comment</span> <span class="ruby-operator">+=</span> <span class="ruby-identifier">filter</span>(<span class="ruby-identifier">line</span>)
107:       <span class="ruby-keyword kw">when</span> <span class="ruby-regexp re">/^=cut/</span>
108:         <span class="ruby-identifier">state</span> = <span class="ruby-identifier">:code_no_blank</span>
109:       <span class="ruby-keyword kw">when</span> <span class="ruby-regexp re">/^=end/</span>
110:         <span class="ruby-identifier">$stderr</span>.<span class="ruby-identifier">puts</span> <span class="ruby-node">&quot;'=end' unexpected at #{line_number} in #{@file_name}&quot;</span>
111:       <span class="ruby-keyword kw">else</span>
112:         <span class="ruby-ivar">@top_level</span>.<span class="ruby-identifier">comment</span> <span class="ruby-operator">+=</span> <span class="ruby-identifier">filter</span>(<span class="ruby-identifier">line</span>)
113:       <span class="ruby-keyword kw">end</span>
114:     <span class="ruby-keyword kw">end</span>
115: 
116: 
117:     <span class="ruby-identifier">process_begin</span> = <span class="ruby-identifier">lambda</span> <span class="ruby-keyword kw">do</span>
118:       <span class="ruby-keyword kw">case</span> <span class="ruby-identifier">line</span>
119:       <span class="ruby-keyword kw">when</span>  <span class="ruby-regexp re">/^\s*$/</span>
120:         <span class="ruby-identifier">state</span> = <span class="ruby-identifier">:begin_blank</span>
121:         <span class="ruby-ivar">@top_level</span>.<span class="ruby-identifier">comment</span> <span class="ruby-operator">+=</span> <span class="ruby-identifier">filter</span>(<span class="ruby-identifier">line</span>)
122:       <span class="ruby-keyword kw">when</span> <span class="ruby-regexp re">/^=end/</span>
123:         <span class="ruby-identifier">state</span> = <span class="ruby-identifier">:code_no_blank</span>
124:       <span class="ruby-keyword kw">when</span> <span class="ruby-regexp re">/^=cut/</span>
125:         <span class="ruby-identifier">$stderr</span>.<span class="ruby-identifier">puts</span> <span class="ruby-node">&quot;'=cut' unexpected at #{line_number} in #{@file_name}&quot;</span>
126:       <span class="ruby-keyword kw">else</span>
127:         <span class="ruby-ivar">@top_level</span>.<span class="ruby-identifier">comment</span> <span class="ruby-operator">+=</span> <span class="ruby-identifier">filter</span>(<span class="ruby-identifier">line</span>)
128:       <span class="ruby-keyword kw">end</span>
129: 
130:     <span class="ruby-keyword kw">end</span>
131: 
132: 
133:     <span class="ruby-identifier">transitions</span> = { <span class="ruby-identifier">:code_no_blank</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">code_noop</span>,
134:                     <span class="ruby-identifier">:code_blank</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">transit_to_pod</span>,
135:                     <span class="ruby-identifier">:pod_no_blank</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">pod_noop</span>,
136:                     <span class="ruby-identifier">:pod_blank</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">process_pod</span>,
137:                     <span class="ruby-identifier">:begin_no_blank</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">begin_noop</span>,
138:                     <span class="ruby-identifier">:begin_blank</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">process_begin</span>}
139:     <span class="ruby-ivar">@content</span>.<span class="ruby-identifier">each_line</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">l</span><span class="ruby-operator">|</span>
140:       <span class="ruby-identifier">line</span> = <span class="ruby-identifier">l</span>
141:       <span class="ruby-identifier">line_number</span> <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>
142:       <span class="ruby-identifier">transitions</span>[<span class="ruby-identifier">state</span>].<span class="ruby-identifier">call</span>
143:     <span class="ruby-keyword kw">end</span> <span class="ruby-comment cmt"># each line</span>
144: 
145:     <span class="ruby-ivar">@top_level</span>
146:   <span class="ruby-keyword kw">end</span></pre>
</body>
</html>
