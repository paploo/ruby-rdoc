<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
  <title>parse_method (RDoc::Parser::Ruby)</title>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <link rel="stylesheet" href="../../../.././rdoc-style.css" type="text/css" media="screen" />
</head>
<body class="standalone-code">
  <pre>      <span class="ruby-comment cmt"># File lib/rdoc/parser/ruby.rb, line 2100</span>
2100:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">parse_method</span>(<span class="ruby-identifier">container</span>, <span class="ruby-identifier">single</span>, <span class="ruby-identifier">tk</span>, <span class="ruby-identifier">comment</span>)
2101:     <span class="ruby-identifier">line_no</span> = <span class="ruby-identifier">tk</span>.<span class="ruby-identifier">line_no</span>
2102:     <span class="ruby-identifier">column</span>  = <span class="ruby-identifier">tk</span>.<span class="ruby-identifier">char_no</span>
2103: 
2104:     <span class="ruby-identifier">start_collecting_tokens</span>
2105:     <span class="ruby-identifier">add_token</span>(<span class="ruby-identifier">tk</span>)
2106:     <span class="ruby-identifier">add_token_listener</span>(<span class="ruby-keyword kw">self</span>)
2107: 
2108:     <span class="ruby-ivar">@scanner</span>.<span class="ruby-identifier">instance_eval</span> <span class="ruby-keyword kw">do</span> <span class="ruby-ivar">@lex_state</span> = <span class="ruby-constant">EXPR_FNAME</span> <span class="ruby-keyword kw">end</span>
2109: 
2110:     <span class="ruby-identifier">skip_tkspace</span>(<span class="ruby-keyword kw">false</span>)
2111:     <span class="ruby-identifier">name_t</span> = <span class="ruby-identifier">get_tk</span>
2112:     <span class="ruby-identifier">back_tk</span> = <span class="ruby-identifier">skip_tkspace</span>
2113:     <span class="ruby-identifier">meth</span> = <span class="ruby-keyword kw">nil</span>
2114:     <span class="ruby-identifier">added_container</span> = <span class="ruby-keyword kw">false</span>
2115: 
2116:     <span class="ruby-identifier">dot</span> = <span class="ruby-identifier">get_tk</span>
2117:     <span class="ruby-keyword kw">if</span> <span class="ruby-constant">TkDOT</span> <span class="ruby-operator">===</span> <span class="ruby-identifier">dot</span> <span class="ruby-keyword kw">or</span> <span class="ruby-constant">TkCOLON2</span> <span class="ruby-operator">===</span> <span class="ruby-identifier">dot</span> <span class="ruby-keyword kw">then</span>
2118:       <span class="ruby-ivar">@scanner</span>.<span class="ruby-identifier">instance_eval</span> <span class="ruby-keyword kw">do</span> <span class="ruby-ivar">@lex_state</span> = <span class="ruby-constant">EXPR_FNAME</span> <span class="ruby-keyword kw">end</span>
2119:       <span class="ruby-identifier">skip_tkspace</span>
2120:       <span class="ruby-identifier">name_t2</span> = <span class="ruby-identifier">get_tk</span>
2121: 
2122:       <span class="ruby-keyword kw">case</span> <span class="ruby-identifier">name_t</span>
2123:       <span class="ruby-keyword kw">when</span> <span class="ruby-constant">TkSELF</span> <span class="ruby-keyword kw">then</span>
2124:         <span class="ruby-identifier">name</span> = <span class="ruby-identifier">name_t2</span>.<span class="ruby-identifier">name</span>
2125:       <span class="ruby-keyword kw">when</span> <span class="ruby-constant">TkCONSTANT</span> <span class="ruby-keyword kw">then</span>
2126:         <span class="ruby-identifier">name</span> = <span class="ruby-identifier">name_t2</span>.<span class="ruby-identifier">name</span>
2127:         <span class="ruby-identifier">prev_container</span> = <span class="ruby-identifier">container</span>
2128:         <span class="ruby-identifier">container</span> = <span class="ruby-identifier">container</span>.<span class="ruby-identifier">find_module_named</span>(<span class="ruby-identifier">name_t</span>.<span class="ruby-identifier">name</span>)
2129:         <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">container</span> <span class="ruby-keyword kw">then</span>
2130:           <span class="ruby-identifier">added_container</span> = <span class="ruby-keyword kw">true</span>
2131:           <span class="ruby-identifier">obj</span> = <span class="ruby-identifier">name_t</span>.<span class="ruby-identifier">name</span>.<span class="ruby-identifier">split</span>(<span class="ruby-value str">&quot;::&quot;</span>).<span class="ruby-identifier">inject</span>(<span class="ruby-constant">Object</span>) <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">state</span>, <span class="ruby-identifier">item</span><span class="ruby-operator">|</span>
2132:             <span class="ruby-identifier">state</span>.<span class="ruby-identifier">const_get</span>(<span class="ruby-identifier">item</span>)
2133:           <span class="ruby-keyword kw">end</span> <span class="ruby-keyword kw">rescue</span> <span class="ruby-keyword kw">nil</span>
2134: 
2135:           <span class="ruby-identifier">type</span> = <span class="ruby-identifier">obj</span>.<span class="ruby-identifier">class</span> <span class="ruby-operator">==</span> <span class="ruby-constant">Class</span> <span class="ruby-value">? </span><span class="ruby-constant">RDoc</span><span class="ruby-operator">::</span><span class="ruby-constant">NormalClass</span> <span class="ruby-operator">:</span> <span class="ruby-constant">RDoc</span><span class="ruby-operator">::</span><span class="ruby-constant">NormalModule</span>
2136: 
2137:           <span class="ruby-keyword kw">unless</span> [<span class="ruby-constant">Class</span>, <span class="ruby-constant">Module</span>].<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">obj</span>.<span class="ruby-identifier">class</span>) <span class="ruby-keyword kw">then</span>
2138:             <span class="ruby-identifier">warn</span>(<span class="ruby-node">&quot;Couldn't find #{name_t.name}. Assuming it's a module&quot;</span>)
2139:           <span class="ruby-keyword kw">end</span>
2140: 
2141:           <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">type</span> <span class="ruby-operator">==</span> <span class="ruby-constant">RDoc</span><span class="ruby-operator">::</span><span class="ruby-constant">NormalClass</span> <span class="ruby-keyword kw">then</span>
2142:             <span class="ruby-identifier">container</span> = <span class="ruby-identifier">prev_container</span>.<span class="ruby-identifier">add_class</span>(<span class="ruby-identifier">type</span>, <span class="ruby-identifier">name_t</span>.<span class="ruby-identifier">name</span>, <span class="ruby-identifier">obj</span>.<span class="ruby-identifier">superclass</span>.<span class="ruby-identifier">name</span>)
2143:           <span class="ruby-keyword kw">else</span>
2144:             <span class="ruby-identifier">container</span> = <span class="ruby-identifier">prev_container</span>.<span class="ruby-identifier">add_module</span>(<span class="ruby-identifier">type</span>, <span class="ruby-identifier">name_t</span>.<span class="ruby-identifier">name</span>)
2145:           <span class="ruby-keyword kw">end</span>
2146: 
2147:           <span class="ruby-identifier">container</span>.<span class="ruby-identifier">record_location</span> <span class="ruby-ivar">@top_level</span>
2148:         <span class="ruby-keyword kw">end</span>
2149:       <span class="ruby-keyword kw">else</span>
2150:         <span class="ruby-comment cmt"># warn(&quot;Unexpected token '#{name_t2.inspect}'&quot;)</span>
2151:         <span class="ruby-comment cmt"># break</span>
2152:         <span class="ruby-identifier">skip_method</span>(<span class="ruby-identifier">container</span>)
2153:         <span class="ruby-keyword kw">return</span>
2154:       <span class="ruby-keyword kw">end</span>
2155: 
2156:       <span class="ruby-identifier">meth</span> = <span class="ruby-constant">RDoc</span><span class="ruby-operator">::</span><span class="ruby-constant">AnyMethod</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">get_tkread</span>, <span class="ruby-identifier">name</span>)
2157:       <span class="ruby-identifier">meth</span>.<span class="ruby-identifier">singleton</span> = <span class="ruby-keyword kw">true</span>
2158:     <span class="ruby-keyword kw">else</span>
2159:       <span class="ruby-identifier">unget_tk</span> <span class="ruby-identifier">dot</span>
2160:       <span class="ruby-identifier">back_tk</span>.<span class="ruby-identifier">reverse_each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">token</span><span class="ruby-operator">|</span>
2161:         <span class="ruby-identifier">unget_tk</span> <span class="ruby-identifier">token</span>
2162:       <span class="ruby-keyword kw">end</span>
2163:       <span class="ruby-identifier">name</span> = <span class="ruby-identifier">name_t</span>.<span class="ruby-identifier">name</span>
2164: 
2165:       <span class="ruby-identifier">meth</span> = <span class="ruby-constant">RDoc</span><span class="ruby-operator">::</span><span class="ruby-constant">AnyMethod</span>.<span class="ruby-identifier">new</span> <span class="ruby-identifier">get_tkread</span>, <span class="ruby-identifier">name</span>
2166:       <span class="ruby-identifier">meth</span>.<span class="ruby-identifier">singleton</span> = (<span class="ruby-identifier">single</span> <span class="ruby-operator">==</span> <span class="ruby-constant">SINGLE</span>)
2167:     <span class="ruby-keyword kw">end</span>
2168: 
2169:     <span class="ruby-ivar">@stats</span>.<span class="ruby-identifier">add_method</span> <span class="ruby-identifier">meth</span>
2170: 
2171:     <span class="ruby-identifier">remove_token_listener</span> <span class="ruby-keyword kw">self</span>
2172: 
2173:     <span class="ruby-identifier">meth</span>.<span class="ruby-identifier">start_collecting_tokens</span>
2174:     <span class="ruby-identifier">indent</span> = <span class="ruby-constant">TkSPACE</span>.<span class="ruby-identifier">new</span> <span class="ruby-value">1</span>, <span class="ruby-value">1</span>
2175:     <span class="ruby-identifier">indent</span>.<span class="ruby-identifier">set_text</span> <span class="ruby-value str">&quot; &quot;</span> <span class="ruby-operator">*</span> <span class="ruby-identifier">column</span>
2176: 
2177:     <span class="ruby-identifier">token</span> = <span class="ruby-constant">TkCOMMENT</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">line_no</span>, <span class="ruby-value">1</span>, <span class="ruby-node">&quot;# File #{@top_level.file_absolute_name}, line #{line_no}&quot;</span>)
2178:     <span class="ruby-identifier">meth</span>.<span class="ruby-identifier">add_tokens</span> [<span class="ruby-identifier">token</span>, <span class="ruby-constant">NEWLINE_TOKEN</span>, <span class="ruby-identifier">indent</span>]
2179:     <span class="ruby-identifier">meth</span>.<span class="ruby-identifier">add_tokens</span> <span class="ruby-ivar">@token_stream</span>
2180: 
2181:     <span class="ruby-identifier">add_token_listener</span> <span class="ruby-identifier">meth</span>
2182: 
2183:     <span class="ruby-ivar">@scanner</span>.<span class="ruby-identifier">instance_eval</span> <span class="ruby-keyword kw">do</span> <span class="ruby-ivar">@continue</span> = <span class="ruby-keyword kw">false</span> <span class="ruby-keyword kw">end</span>
2184:     <span class="ruby-identifier">parse_method_parameters</span> <span class="ruby-identifier">meth</span>
2185: 
2186:     <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">meth</span>.<span class="ruby-identifier">document_self</span> <span class="ruby-keyword kw">then</span>
2187:       <span class="ruby-identifier">container</span>.<span class="ruby-identifier">add_method</span> <span class="ruby-identifier">meth</span>
2188:     <span class="ruby-keyword kw">elsif</span> <span class="ruby-identifier">added_container</span> <span class="ruby-keyword kw">then</span>
2189:       <span class="ruby-identifier">container</span>.<span class="ruby-identifier">document_self</span> = <span class="ruby-keyword kw">false</span>
2190:     <span class="ruby-keyword kw">end</span>
2191: 
2192:     <span class="ruby-comment cmt"># Having now read the method parameters and documentation modifiers, we</span>
2193:     <span class="ruby-comment cmt"># now know whether we have to rename #initialize to ::new</span>
2194: 
2195:     <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">name</span> <span class="ruby-operator">==</span> <span class="ruby-value str">&quot;initialize&quot;</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">meth</span>.<span class="ruby-identifier">singleton</span> <span class="ruby-keyword kw">then</span>
2196:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">meth</span>.<span class="ruby-identifier">dont_rename_initialize</span> <span class="ruby-keyword kw">then</span>
2197:         <span class="ruby-identifier">meth</span>.<span class="ruby-identifier">visibility</span> = <span class="ruby-identifier">:protected</span>
2198:       <span class="ruby-keyword kw">else</span>
2199:         <span class="ruby-identifier">meth</span>.<span class="ruby-identifier">singleton</span> = <span class="ruby-keyword kw">true</span>
2200:         <span class="ruby-identifier">meth</span>.<span class="ruby-identifier">name</span> = <span class="ruby-value str">&quot;new&quot;</span>
2201:         <span class="ruby-identifier">meth</span>.<span class="ruby-identifier">visibility</span> = <span class="ruby-identifier">:public</span>
2202:       <span class="ruby-keyword kw">end</span>
2203:     <span class="ruby-keyword kw">end</span>
2204: 
2205:     <span class="ruby-identifier">parse_statements</span>(<span class="ruby-identifier">container</span>, <span class="ruby-identifier">single</span>, <span class="ruby-identifier">meth</span>)
2206: 
2207:     <span class="ruby-identifier">remove_token_listener</span>(<span class="ruby-identifier">meth</span>)
2208: 
2209:     <span class="ruby-identifier">extract_call_seq</span> <span class="ruby-identifier">comment</span>, <span class="ruby-identifier">meth</span>
2210: 
2211:     <span class="ruby-identifier">meth</span>.<span class="ruby-identifier">comment</span> = <span class="ruby-identifier">comment</span>
2212:   <span class="ruby-keyword kw">end</span></pre>
</body>
</html>
