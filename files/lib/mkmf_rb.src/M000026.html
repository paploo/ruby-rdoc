<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
  <title>create_makefile (lib/mkmf.rb)</title>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <link rel="stylesheet" href="../../.././rdoc-style.css" type="text/css" media="screen" />
</head>
<body class="standalone-code">
  <pre>      <span class="ruby-comment cmt"># File lib/mkmf.rb, line 1568</span>
1568: <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">create_makefile</span>(<span class="ruby-identifier">target</span>, <span class="ruby-identifier">srcprefix</span> = <span class="ruby-keyword kw">nil</span>)
1569:   <span class="ruby-identifier">$target</span> = <span class="ruby-identifier">target</span>
1570:   <span class="ruby-identifier">libpath</span> = <span class="ruby-identifier">$DEFLIBPATH</span><span class="ruby-operator">|</span><span class="ruby-identifier">$LIBPATH</span>
1571:   <span class="ruby-identifier">message</span> <span class="ruby-value str">&quot;creating Makefile\n&quot;</span>
1572:   <span class="ruby-identifier">rm_f</span> <span class="ruby-value str">&quot;conftest*&quot;</span>
1573:   <span class="ruby-keyword kw">if</span> <span class="ruby-constant">CONFIG</span>[<span class="ruby-value str">&quot;DLEXT&quot;</span>] <span class="ruby-operator">==</span> <span class="ruby-identifier">$OBJEXT</span>
1574:     <span class="ruby-keyword kw">for</span> <span class="ruby-identifier">lib</span> <span class="ruby-keyword kw">in</span> <span class="ruby-identifier">libs</span> = <span class="ruby-identifier">$libs</span>.<span class="ruby-identifier">split</span>
1575:       <span class="ruby-identifier">lib</span>.<span class="ruby-identifier">sub!</span>(<span class="ruby-regexp re">/-l(.*)/</span>, <span class="ruby-node">%%&quot;lib\\1.#{$LIBEXT}&quot;%</span>)
1576:     <span class="ruby-keyword kw">end</span>
1577:     <span class="ruby-identifier">$defs</span>.<span class="ruby-identifier">push</span>(<span class="ruby-identifier">format</span>(<span class="ruby-value str">&quot;-DEXTLIB='%s'&quot;</span>, <span class="ruby-identifier">libs</span>.<span class="ruby-identifier">join</span>(<span class="ruby-value str">&quot;,&quot;</span>)))
1578:   <span class="ruby-keyword kw">end</span>
1579: 
1580:   <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">target</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-value str">'/'</span>)
1581:     <span class="ruby-identifier">target_prefix</span>, <span class="ruby-identifier">target</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">split</span>(<span class="ruby-identifier">target</span>)
1582:     <span class="ruby-identifier">target_prefix</span>[<span class="ruby-value">0</span>,<span class="ruby-value">0</span>] = <span class="ruby-value str">'/'</span>
1583:   <span class="ruby-keyword kw">else</span>
1584:     <span class="ruby-identifier">target_prefix</span> = <span class="ruby-value str">&quot;&quot;</span>
1585:   <span class="ruby-keyword kw">end</span>
1586: 
1587:   <span class="ruby-identifier">srcprefix</span> <span class="ruby-operator">||=</span> <span class="ruby-value str">'$(srcdir)'</span>
1588:   <span class="ruby-constant">RbConfig</span><span class="ruby-operator">::</span><span class="ruby-identifier">expand</span>(<span class="ruby-identifier">srcdir</span> = <span class="ruby-identifier">srcprefix</span>.<span class="ruby-identifier">dup</span>)
1589: 
1590:   <span class="ruby-keyword kw">if</span> <span class="ruby-keyword kw">not</span> <span class="ruby-identifier">$objs</span>
1591:     <span class="ruby-identifier">$objs</span> = []
1592:     <span class="ruby-identifier">srcs</span> = <span class="ruby-constant">Dir</span>[<span class="ruby-constant">File</span>.<span class="ruby-identifier">join</span>(<span class="ruby-identifier">srcdir</span>, <span class="ruby-node">&quot;*.{#{SRC_EXT.join(%q{,})}}&quot;</span>)]
1593:     <span class="ruby-keyword kw">for</span> <span class="ruby-identifier">f</span> <span class="ruby-keyword kw">in</span> <span class="ruby-identifier">srcs</span>
1594:       <span class="ruby-identifier">obj</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">basename</span>(<span class="ruby-identifier">f</span>, <span class="ruby-value str">&quot;.*&quot;</span>) <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value str">&quot;.o&quot;</span>
1595:       <span class="ruby-identifier">$objs</span>.<span class="ruby-identifier">push</span>(<span class="ruby-identifier">obj</span>) <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">$objs</span>.<span class="ruby-identifier">index</span>(<span class="ruby-identifier">obj</span>)
1596:     <span class="ruby-keyword kw">end</span>
1597:   <span class="ruby-keyword kw">elsif</span> <span class="ruby-operator">!</span>(<span class="ruby-identifier">srcs</span> = <span class="ruby-identifier">$srcs</span>)
1598:     <span class="ruby-identifier">srcs</span> = <span class="ruby-identifier">$objs</span>.<span class="ruby-identifier">collect</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">o</span><span class="ruby-operator">|</span> <span class="ruby-identifier">o</span>.<span class="ruby-identifier">sub</span>(<span class="ruby-regexp re">/\.o\z/</span>, <span class="ruby-value str">'.c'</span>)}
1599:   <span class="ruby-keyword kw">end</span>
1600:   <span class="ruby-identifier">$srcs</span> = <span class="ruby-identifier">srcs</span>
1601:   <span class="ruby-keyword kw">for</span> <span class="ruby-identifier">i</span> <span class="ruby-keyword kw">in</span> <span class="ruby-identifier">$objs</span>
1602:     <span class="ruby-identifier">i</span>.<span class="ruby-identifier">sub!</span>(<span class="ruby-regexp re">/\.o\z/</span>, <span class="ruby-node">&quot;.#{$OBJEXT}&quot;</span>)
1603:   <span class="ruby-keyword kw">end</span>
1604:   <span class="ruby-identifier">$objs</span> = <span class="ruby-identifier">$objs</span>.<span class="ruby-identifier">join</span>(<span class="ruby-value str">&quot; &quot;</span>)
1605: 
1606:   <span class="ruby-identifier">target</span> = <span class="ruby-keyword kw">nil</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">$objs</span> <span class="ruby-operator">==</span> <span class="ruby-value str">&quot;&quot;</span>
1607: 
1608:   <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">target</span> <span class="ruby-keyword kw">and</span> <span class="ruby-constant">EXPORT_PREFIX</span>
1609:     <span class="ruby-keyword kw">if</span> <span class="ruby-constant">File</span>.<span class="ruby-identifier">exist?</span>(<span class="ruby-constant">File</span>.<span class="ruby-identifier">join</span>(<span class="ruby-identifier">srcdir</span>, <span class="ruby-identifier">target</span> <span class="ruby-operator">+</span> <span class="ruby-value str">'.def'</span>))
1610:       <span class="ruby-identifier">deffile</span> = <span class="ruby-value str">&quot;$(srcdir)/$(TARGET).def&quot;</span>
1611:       <span class="ruby-keyword kw">unless</span> <span class="ruby-constant">EXPORT_PREFIX</span>.<span class="ruby-identifier">empty?</span>
1612:         <span class="ruby-identifier">makedef</span> = <span class="ruby-node">%{-pe &quot;$_.sub!(/^(?=\\w)/,'#{EXPORT_PREFIX}') unless 1../^EXPORTS$/i&quot;}</span>
1613:       <span class="ruby-keyword kw">end</span>
1614:     <span class="ruby-keyword kw">else</span>
1615:       <span class="ruby-identifier">makedef</span> = <span class="ruby-node">%{-e &quot;puts 'EXPORTS', '#{EXPORT_PREFIX}Init_$(TARGET)'&quot;}</span>
1616:     <span class="ruby-keyword kw">end</span>
1617:     <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">makedef</span>
1618:       <span class="ruby-identifier">$distcleanfiles</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value str">'$(DEFFILE)'</span>
1619:       <span class="ruby-identifier">origdef</span> = <span class="ruby-identifier">deffile</span>
1620:       <span class="ruby-identifier">deffile</span> = <span class="ruby-value str">&quot;$(TARGET)-$(arch).def&quot;</span>
1621:     <span class="ruby-keyword kw">end</span>
1622:   <span class="ruby-keyword kw">end</span>
1623:   <span class="ruby-identifier">origdef</span> <span class="ruby-operator">||=</span> <span class="ruby-value str">''</span>
1624: 
1625:   <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">$extout</span> <span class="ruby-keyword kw">and</span> <span class="ruby-identifier">$INSTALLFILES</span>
1626:     <span class="ruby-identifier">$cleanfiles</span>.<span class="ruby-identifier">concat</span>(<span class="ruby-identifier">$INSTALLFILES</span>.<span class="ruby-identifier">collect</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">files</span>, <span class="ruby-identifier">dir</span><span class="ruby-operator">|</span><span class="ruby-constant">File</span>.<span class="ruby-identifier">join</span>(<span class="ruby-identifier">dir</span>, <span class="ruby-identifier">files</span>.<span class="ruby-identifier">sub</span>(<span class="ruby-regexp re">/\A\.\//</span>, <span class="ruby-value str">''</span>))})
1627:     <span class="ruby-identifier">$distcleandirs</span>.<span class="ruby-identifier">concat</span>(<span class="ruby-identifier">$INSTALLFILES</span>.<span class="ruby-identifier">collect</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">files</span>, <span class="ruby-identifier">dir</span><span class="ruby-operator">|</span> <span class="ruby-identifier">dir</span>})
1628:   <span class="ruby-keyword kw">end</span>
1629: 
1630:   <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">$extmk</span> <span class="ruby-keyword kw">and</span> <span class="ruby-keyword kw">not</span> <span class="ruby-identifier">$extconf_h</span>
1631:     <span class="ruby-identifier">create_header</span>
1632:   <span class="ruby-keyword kw">end</span>
1633: 
1634:   <span class="ruby-identifier">libpath</span> = <span class="ruby-identifier">libpathflag</span>(<span class="ruby-identifier">libpath</span>)
1635: 
1636:   <span class="ruby-identifier">dllib</span> = <span class="ruby-identifier">target</span> <span class="ruby-value">? </span><span class="ruby-node">&quot;$(TARGET).#{CONFIG['DLEXT']}&quot;</span> <span class="ruby-operator">:</span> <span class="ruby-value str">&quot;&quot;</span>
1637:   <span class="ruby-identifier">staticlib</span> = <span class="ruby-identifier">target</span> <span class="ruby-value">? </span><span class="ruby-value str">&quot;$(TARGET).#$LIBEXT&quot;</span> <span class="ruby-operator">:</span> <span class="ruby-value str">&quot;&quot;</span>
1638:   <span class="ruby-identifier">mfile</span> = <span class="ruby-identifier">open</span>(<span class="ruby-value str">&quot;Makefile&quot;</span>, <span class="ruby-value str">&quot;wb&quot;</span>)
1639:   <span class="ruby-identifier">mfile</span>.<span class="ruby-identifier">print</span>(<span class="ruby-operator">*</span><span class="ruby-identifier">configuration</span>(<span class="ruby-identifier">srcprefix</span>))
1640:   <span class="ruby-identifier">mfile</span>.<span class="ruby-identifier">print</span> <span class="ruby-node">&quot;
1641: libpath = #{($DEFLIBPATH|$LIBPATH).join(&quot; &quot;)}
1642: LIBPATH = #{libpath}
1643: DEFFILE = #{deffile}
1644: 
1645: CLEANFILES = #{$cleanfiles.join(' ')}
1646: DISTCLEANFILES = #{$distcleanfiles.join(' ')}
1647: DISTCLEANDIRS = #{$distcleandirs.join(' ')}
1648: 
1649: extout = #{$extout}
1650: extout_prefix = #{$extout_prefix}
1651: target_prefix = #{target_prefix}
1652: LOCAL_LIBS = #{$LOCAL_LIBS}
1653: LIBS = #{$LIBRUBYARG} #{$libs} #{$LIBS}
1654: SRCS = #{srcs.collect(&amp;File.method(:basename)).join(' ')}
1655: OBJS = #{$objs}
1656: TARGET = #{target}
1657: DLLIB = #{dllib}
1658: EXTSTATIC = #{$static || &quot;&quot;}
1659: STATIC_LIB = #{staticlib unless $static.nil?}
1660: #{!$extout &amp;&amp; defined?($installed_list) ? &quot;INSTALLED_LIST = #{$installed_list}\n&quot; : &quot;&quot;}
1661: &quot;</span> <span class="ruby-comment cmt">#&quot;</span>
1662:   <span class="ruby-comment cmt"># TODO: fixme</span>
1663:   <span class="ruby-identifier">install_dirs</span>.<span class="ruby-identifier">each</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">d</span><span class="ruby-operator">|</span> <span class="ruby-identifier">mfile</span>.<span class="ruby-identifier">print</span>(<span class="ruby-value str">&quot;%-14s= %s\n&quot;</span> <span class="ruby-operator">%</span> <span class="ruby-identifier">d</span>) <span class="ruby-keyword kw">if</span> <span class="ruby-regexp re">/^[[:upper:]]/</span> <span class="ruby-operator">=~</span> <span class="ruby-identifier">d</span>[<span class="ruby-value">0</span>]}
1664:   <span class="ruby-identifier">n</span> = (<span class="ruby-identifier">$extout</span> <span class="ruby-operator">?</span> <span class="ruby-value str">'$(RUBYARCHDIR)/'</span> <span class="ruby-operator">:</span> <span class="ruby-value str">''</span>) <span class="ruby-operator">+</span> <span class="ruby-value str">'$(TARGET)'</span>
1665:   <span class="ruby-identifier">mfile</span>.<span class="ruby-identifier">print</span> <span class="ruby-node">&quot;
1666: TARGET_SO     = #{($extout ? '$(RUBYARCHDIR)/' : '')}$(DLLIB)
1667: CLEANLIBS     = #{n}.#{CONFIG['DLEXT']} #{config_string('cleanlibs') {|t| t.gsub(/\$\*/) {n}}}
1668: CLEANOBJS     = *.#{$OBJEXT} #{config_string('cleanobjs') {|t| t.gsub(/\$\*/, '$(TARGET)')}} *.bak
1669: 
1670: all:    #{$extout ? &quot;install&quot; : target ? &quot;$(DLLIB)&quot; : &quot;Makefile&quot;}
1671: static: $(STATIC_LIB)#{$extout ? &quot; install-rb&quot; : &quot;&quot;}
1672: &quot;</span>
1673:   <span class="ruby-identifier">mfile</span>.<span class="ruby-identifier">print</span> <span class="ruby-constant">CLEANINGS</span>
1674:   <span class="ruby-identifier">fsep</span> = <span class="ruby-identifier">config_string</span>(<span class="ruby-value str">'BUILD_FILE_SEPARATOR'</span>) {<span class="ruby-operator">|</span><span class="ruby-identifier">s</span><span class="ruby-operator">|</span> <span class="ruby-identifier">s</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">s</span> <span class="ruby-operator">==</span> <span class="ruby-value str">&quot;/&quot;</span>}
1675:   <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">fsep</span>
1676:     <span class="ruby-identifier">sep</span> = <span class="ruby-node">&quot;:/=#{fsep}&quot;</span>
1677:     <span class="ruby-identifier">fseprepl</span> = <span class="ruby-identifier">proc</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">s</span><span class="ruby-operator">|</span>
1678:       <span class="ruby-identifier">s</span> = <span class="ruby-identifier">s</span>.<span class="ruby-identifier">gsub</span>(<span class="ruby-value str">&quot;/&quot;</span>, <span class="ruby-identifier">fsep</span>)
1679:       <span class="ruby-identifier">s</span> = <span class="ruby-identifier">s</span>.<span class="ruby-identifier">gsub</span>(<span class="ruby-regexp re">/(\$\(\w+)(\))/</span>) {<span class="ruby-identifier">$1</span><span class="ruby-operator">+</span><span class="ruby-identifier">sep</span><span class="ruby-operator">+</span><span class="ruby-identifier">$2</span>}
1680:       <span class="ruby-identifier">s</span> = <span class="ruby-identifier">s</span>.<span class="ruby-identifier">gsub</span>(<span class="ruby-regexp re">/(\$\{\w+)(\})/</span>) {<span class="ruby-identifier">$1</span><span class="ruby-operator">+</span><span class="ruby-identifier">sep</span><span class="ruby-operator">+</span><span class="ruby-identifier">$2</span>}
1681:     }
1682:   <span class="ruby-keyword kw">else</span>
1683:     <span class="ruby-identifier">fseprepl</span> = <span class="ruby-identifier">proc</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">s</span><span class="ruby-operator">|</span> <span class="ruby-identifier">s</span>}
1684:     <span class="ruby-identifier">sep</span> = <span class="ruby-value str">&quot;&quot;</span>
1685:   <span class="ruby-keyword kw">end</span>
1686:   <span class="ruby-identifier">dirs</span> = []
1687:   <span class="ruby-identifier">mfile</span>.<span class="ruby-identifier">print</span> <span class="ruby-value str">&quot;install: install-so install-rb\n\n&quot;</span>
1688:   <span class="ruby-identifier">sodir</span> = (<span class="ruby-identifier">dir</span> = <span class="ruby-value str">&quot;$(RUBYARCHDIR)&quot;</span>).<span class="ruby-identifier">dup</span>
1689:   <span class="ruby-identifier">mfile</span>.<span class="ruby-identifier">print</span>(<span class="ruby-value str">&quot;install-so: &quot;</span>)
1690:   <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">target</span>
1691:     <span class="ruby-identifier">f</span> = <span class="ruby-value str">&quot;$(DLLIB)&quot;</span>
1692:     <span class="ruby-identifier">dest</span> = <span class="ruby-node">&quot;#{dir}/#{f}&quot;</span>
1693:     <span class="ruby-identifier">mfile</span>.<span class="ruby-identifier">puts</span> <span class="ruby-identifier">dir</span>, <span class="ruby-node">&quot;install-so: #{dest}&quot;</span>
1694:     <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">$extout</span>
1695:       <span class="ruby-identifier">mfile</span>.<span class="ruby-identifier">print</span> <span class="ruby-value str">&quot;clean-so::\n&quot;</span>
1696:       <span class="ruby-identifier">mfile</span>.<span class="ruby-identifier">print</span> <span class="ruby-node">&quot;\t@-$(RM) #{fseprepl[dest]}\n&quot;</span>
1697:       <span class="ruby-identifier">mfile</span>.<span class="ruby-identifier">print</span> <span class="ruby-node">&quot;\t@-$(RMDIRS) #{fseprepl[dir]}\n&quot;</span>
1698:     <span class="ruby-keyword kw">else</span>
1699:       <span class="ruby-identifier">mfile</span>.<span class="ruby-identifier">print</span> <span class="ruby-node">&quot;#{dest}: #{f}\n&quot;</span>
1700:       <span class="ruby-identifier">mfile</span>.<span class="ruby-identifier">print</span> <span class="ruby-node">&quot;\t$(INSTALL_PROG) #{fseprepl[f]} #{fseprepl[dir]}\n&quot;</span>
1701:       <span class="ruby-keyword kw">if</span> <span class="ruby-keyword kw">defined?</span>(<span class="ruby-identifier">$installed_list</span>)
1702:         <span class="ruby-identifier">mfile</span>.<span class="ruby-identifier">print</span> <span class="ruby-node">&quot;\t@echo #{dir}/#{File.basename(f)}&gt;&gt;$(INSTALLED_LIST)\n&quot;</span>
1703:       <span class="ruby-keyword kw">end</span>
1704:     <span class="ruby-keyword kw">end</span>
1705:   <span class="ruby-keyword kw">else</span>
1706:     <span class="ruby-identifier">mfile</span>.<span class="ruby-identifier">puts</span> <span class="ruby-value str">&quot;Makefile&quot;</span>
1707:   <span class="ruby-keyword kw">end</span>
1708:   <span class="ruby-identifier">mfile</span>.<span class="ruby-identifier">print</span>(<span class="ruby-value str">&quot;install-rb: pre-install-rb install-rb-default\n&quot;</span>)
1709:   <span class="ruby-identifier">mfile</span>.<span class="ruby-identifier">print</span>(<span class="ruby-value str">&quot;install-rb-default: pre-install-rb-default\n&quot;</span>)
1710:   <span class="ruby-identifier">mfile</span>.<span class="ruby-identifier">print</span>(<span class="ruby-value str">&quot;pre-install-rb: Makefile\n&quot;</span>)
1711:   <span class="ruby-identifier">mfile</span>.<span class="ruby-identifier">print</span>(<span class="ruby-value str">&quot;pre-install-rb-default: Makefile\n&quot;</span>)
1712:   <span class="ruby-keyword kw">for</span> <span class="ruby-identifier">sfx</span>, <span class="ruby-identifier">i</span> <span class="ruby-keyword kw">in</span> [[<span class="ruby-value str">&quot;-default&quot;</span>, [[<span class="ruby-value str">&quot;lib/**/*.rb&quot;</span>, <span class="ruby-value str">&quot;$(RUBYLIBDIR)&quot;</span>, <span class="ruby-value str">&quot;lib&quot;</span>]]], [<span class="ruby-value str">&quot;&quot;</span>, <span class="ruby-identifier">$INSTALLFILES</span>]]
1713:     <span class="ruby-identifier">files</span> = <span class="ruby-identifier">install_files</span>(<span class="ruby-identifier">mfile</span>, <span class="ruby-identifier">i</span>, <span class="ruby-keyword kw">nil</span>, <span class="ruby-identifier">srcprefix</span>) <span class="ruby-keyword kw">or</span> <span class="ruby-keyword kw">next</span>
1714:     <span class="ruby-keyword kw">for</span> <span class="ruby-identifier">dir</span>, <span class="ruby-operator">*</span><span class="ruby-identifier">files</span> <span class="ruby-keyword kw">in</span> <span class="ruby-identifier">files</span>
1715:       <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">dirs</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">dir</span>)
1716:         <span class="ruby-identifier">dirs</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">dir</span>
1717:         <span class="ruby-identifier">mfile</span>.<span class="ruby-identifier">print</span> <span class="ruby-node">&quot;pre-install-rb#{sfx}: #{dir}\n&quot;</span>
1718:       <span class="ruby-keyword kw">end</span>
1719:       <span class="ruby-keyword kw">for</span> <span class="ruby-identifier">f</span> <span class="ruby-keyword kw">in</span> <span class="ruby-identifier">files</span>
1720:         <span class="ruby-identifier">dest</span> = <span class="ruby-node">&quot;#{dir}/#{File.basename(f)}&quot;</span>
1721:         <span class="ruby-identifier">mfile</span>.<span class="ruby-identifier">print</span>(<span class="ruby-node">&quot;install-rb#{sfx}: #{dest}\n&quot;</span>)
1722:         <span class="ruby-identifier">mfile</span>.<span class="ruby-identifier">print</span>(<span class="ruby-node">&quot;#{dest}: #{f}\n&quot;</span>)
1723:         <span class="ruby-identifier">mfile</span>.<span class="ruby-identifier">print</span>(<span class="ruby-node">&quot;\t$(#{$extout ? 'COPY' : 'INSTALL_DATA'}) &quot;</span>)
1724:         <span class="ruby-identifier">mfile</span>.<span class="ruby-identifier">print</span>(<span class="ruby-node">&quot;#{fseprepl[f]} $(@D#{sep})\n&quot;</span>)
1725:         <span class="ruby-keyword kw">if</span> <span class="ruby-keyword kw">defined?</span>(<span class="ruby-identifier">$installed_list</span>) <span class="ruby-keyword kw">and</span> <span class="ruby-operator">!</span><span class="ruby-identifier">$extout</span>
1726:           <span class="ruby-identifier">mfile</span>.<span class="ruby-identifier">print</span>(<span class="ruby-node">&quot;\t@echo #{dest}&gt;&gt;$(INSTALLED_LIST)\n&quot;</span>)
1727:         <span class="ruby-keyword kw">end</span>
1728:         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">$extout</span>
1729:           <span class="ruby-identifier">mfile</span>.<span class="ruby-identifier">print</span>(<span class="ruby-node">&quot;clean-rb#{sfx}::\n&quot;</span>)
1730:           <span class="ruby-identifier">mfile</span>.<span class="ruby-identifier">print</span>(<span class="ruby-node">&quot;\t@-$(RM) #{fseprepl[dest]}\n&quot;</span>)
1731:         <span class="ruby-keyword kw">end</span>
1732:       <span class="ruby-keyword kw">end</span>
1733:     <span class="ruby-keyword kw">end</span>
1734:     <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">$extout</span>
1735:       <span class="ruby-identifier">dirs</span>.<span class="ruby-identifier">uniq!</span>
1736:       <span class="ruby-identifier">dirs</span>.<span class="ruby-identifier">reverse!</span>
1737:       <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">dirs</span>.<span class="ruby-identifier">empty?</span>
1738:         <span class="ruby-identifier">mfile</span>.<span class="ruby-identifier">print</span>(<span class="ruby-node">&quot;clean-rb#{sfx}::\n&quot;</span>)
1739:         <span class="ruby-keyword kw">for</span> <span class="ruby-identifier">dir</span> <span class="ruby-keyword kw">in</span> <span class="ruby-identifier">dirs</span>
1740:           <span class="ruby-identifier">mfile</span>.<span class="ruby-identifier">print</span>(<span class="ruby-node">&quot;\t@-$(RMDIRS) #{fseprepl[dir]}\n&quot;</span>)
1741:         <span class="ruby-keyword kw">end</span>
1742:       <span class="ruby-keyword kw">end</span>
1743:     <span class="ruby-keyword kw">end</span>
1744:   <span class="ruby-keyword kw">end</span>
1745:   <span class="ruby-identifier">dirs</span>.<span class="ruby-identifier">unshift</span>(<span class="ruby-identifier">sodir</span>) <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">target</span> <span class="ruby-keyword kw">and</span> <span class="ruby-operator">!</span><span class="ruby-identifier">dirs</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">sodir</span>)
1746:   <span class="ruby-identifier">dirs</span>.<span class="ruby-identifier">each</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">d</span><span class="ruby-operator">|</span> <span class="ruby-identifier">mfile</span>.<span class="ruby-identifier">print</span> <span class="ruby-node">&quot;#{d}:\n\t$(MAKEDIRS) $@\n&quot;</span>}
1747: 
1748:   <span class="ruby-identifier">mfile</span>.<span class="ruby-identifier">print</span> <span class="ruby-value str">&quot;\nsite-install: site-install-so site-install-rb\nsite-install-so: install-so\nsite-install-rb: install-rb\n\n&quot;</span>
1749: 
1750:   <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">target</span>
1751: 
1752:   <span class="ruby-identifier">mfile</span>.<span class="ruby-identifier">puts</span> <span class="ruby-constant">SRC_EXT</span>.<span class="ruby-identifier">collect</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">ext</span><span class="ruby-operator">|</span> <span class="ruby-node">&quot;.path.#{ext} = $(VPATH)&quot;</span>} <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">$nmake</span> <span class="ruby-operator">==</span> <span class="ruby-value">?b</span>
1753:   <span class="ruby-identifier">mfile</span>.<span class="ruby-identifier">print</span> <span class="ruby-node">&quot;.SUFFIXES: .#{SRC_EXT.join(' .')} .#{$OBJEXT}\n&quot;</span>
1754:   <span class="ruby-identifier">mfile</span>.<span class="ruby-identifier">print</span> <span class="ruby-value str">&quot;\n&quot;</span>
1755: 
1756:   <span class="ruby-constant">CXX_EXT</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">ext</span><span class="ruby-operator">|</span>
1757:     <span class="ruby-constant">COMPILE_RULES</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">rule</span><span class="ruby-operator">|</span>
1758:       <span class="ruby-identifier">mfile</span>.<span class="ruby-identifier">printf</span>(<span class="ruby-identifier">rule</span>, <span class="ruby-identifier">ext</span>, <span class="ruby-identifier">$OBJEXT</span>)
1759:       <span class="ruby-identifier">mfile</span>.<span class="ruby-identifier">printf</span>(<span class="ruby-value str">&quot;\n\t%s\n\n&quot;</span>, <span class="ruby-constant">COMPILE_CXX</span>)
1760:     <span class="ruby-keyword kw">end</span>
1761:   <span class="ruby-keyword kw">end</span>
1762:   <span class="ruby-node">%w[c]</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">ext</span><span class="ruby-operator">|</span>
1763:     <span class="ruby-constant">COMPILE_RULES</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">rule</span><span class="ruby-operator">|</span>
1764:       <span class="ruby-identifier">mfile</span>.<span class="ruby-identifier">printf</span>(<span class="ruby-identifier">rule</span>, <span class="ruby-identifier">ext</span>, <span class="ruby-identifier">$OBJEXT</span>)
1765:       <span class="ruby-identifier">mfile</span>.<span class="ruby-identifier">printf</span>(<span class="ruby-value str">&quot;\n\t%s\n\n&quot;</span>, <span class="ruby-constant">COMPILE_C</span>)
1766:     <span class="ruby-keyword kw">end</span>
1767:   <span class="ruby-keyword kw">end</span>
1768: 
1769:   <span class="ruby-identifier">mfile</span>.<span class="ruby-identifier">print</span> <span class="ruby-value str">&quot;$(RUBYARCHDIR)/&quot;</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">$extout</span>
1770:   <span class="ruby-identifier">mfile</span>.<span class="ruby-identifier">print</span> <span class="ruby-value str">&quot;$(DLLIB): &quot;</span>
1771:   <span class="ruby-identifier">mfile</span>.<span class="ruby-identifier">print</span> <span class="ruby-value str">&quot;$(DEFFILE) &quot;</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">makedef</span>
1772:   <span class="ruby-identifier">mfile</span>.<span class="ruby-identifier">print</span> <span class="ruby-value str">&quot;$(OBJS) Makefile\n&quot;</span>
1773:   <span class="ruby-identifier">mfile</span>.<span class="ruby-identifier">print</span> <span class="ruby-node">&quot;\t@-$(RM) $(@#{sep})\n&quot;</span>
1774:   <span class="ruby-identifier">mfile</span>.<span class="ruby-identifier">print</span> <span class="ruby-value str">&quot;\t@-$(MAKEDIRS) $(@D)\n&quot;</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">$extout</span>
1775:   <span class="ruby-identifier">link_so</span> = <span class="ruby-constant">LINK_SO</span>.<span class="ruby-identifier">gsub</span>(<span class="ruby-regexp re">/^/</span>, <span class="ruby-value str">&quot;\t&quot;</span>)
1776:   <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">srcs</span>.<span class="ruby-identifier">any?</span>(<span class="ruby-operator">&amp;</span><span class="ruby-node">%r&quot;\.(?:#{CXX_EXT.join('|')})\z&quot;</span>.<span class="ruby-identifier">method</span>(<span class="ruby-identifier">:===</span>))
1777:     <span class="ruby-identifier">link_so</span> = <span class="ruby-identifier">link_so</span>.<span class="ruby-identifier">sub</span>(<span class="ruby-regexp re">/\bLDSHARED\b/</span>, <span class="ruby-value str">'\&amp;XX'</span>)
1778:   <span class="ruby-keyword kw">end</span>
1779:   <span class="ruby-identifier">mfile</span>.<span class="ruby-identifier">print</span> <span class="ruby-identifier">link_so</span>, <span class="ruby-value str">&quot;\n\n&quot;</span>
1780:   <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">$static</span>.<span class="ruby-identifier">nil?</span>
1781:     <span class="ruby-identifier">mfile</span>.<span class="ruby-identifier">print</span> <span class="ruby-node">&quot;$(STATIC_LIB): $(OBJS)\n\t@-$(RM) $(@#{sep})\n\t&quot;</span>
1782:     <span class="ruby-identifier">mfile</span>.<span class="ruby-identifier">print</span> <span class="ruby-node">&quot;$(AR) #{config_string('ARFLAGS') || 'cru '}$@ $(OBJS)&quot;</span>
1783:     <span class="ruby-identifier">config_string</span>(<span class="ruby-value str">'RANLIB'</span>) <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">ranlib</span><span class="ruby-operator">|</span>
1784:       <span class="ruby-identifier">mfile</span>.<span class="ruby-identifier">print</span> <span class="ruby-node">&quot;\n\t@-#{ranlib} $(DLLIB) 2&gt; /dev/null || true&quot;</span>
1785:     <span class="ruby-keyword kw">end</span>
1786:   <span class="ruby-keyword kw">end</span>
1787:   <span class="ruby-identifier">mfile</span>.<span class="ruby-identifier">print</span> <span class="ruby-value str">&quot;\n\n&quot;</span>
1788:   <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">makedef</span>
1789:     <span class="ruby-identifier">mfile</span>.<span class="ruby-identifier">print</span> <span class="ruby-node">&quot;$(DEFFILE): #{origdef}\n&quot;</span>
1790:     <span class="ruby-identifier">mfile</span>.<span class="ruby-identifier">print</span> <span class="ruby-node">&quot;\t$(RUBY) #{makedef} #{origdef} &gt; $@\n\n&quot;</span>
1791:   <span class="ruby-keyword kw">end</span>
1792: 
1793:   <span class="ruby-identifier">depend</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">join</span>(<span class="ruby-identifier">srcdir</span>, <span class="ruby-value str">&quot;depend&quot;</span>)
1794:   <span class="ruby-keyword kw">if</span> <span class="ruby-constant">File</span>.<span class="ruby-identifier">exist?</span>(<span class="ruby-identifier">depend</span>)
1795:     <span class="ruby-identifier">mfile</span>.<span class="ruby-identifier">print</span>(<span class="ruby-value str">&quot;###\n&quot;</span>, <span class="ruby-operator">*</span><span class="ruby-identifier">depend_rules</span>(<span class="ruby-constant">File</span>.<span class="ruby-identifier">read</span>(<span class="ruby-identifier">depend</span>)))
1796:   <span class="ruby-keyword kw">else</span>
1797:     <span class="ruby-identifier">headers</span> = <span class="ruby-node">%w[$(hdrdir)/ruby.h $(hdrdir)/ruby/defines.h]</span>
1798:     <span class="ruby-keyword kw">if</span> <span class="ruby-constant">RULE_SUBST</span>
1799:       <span class="ruby-identifier">headers</span>.<span class="ruby-identifier">each</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">h</span><span class="ruby-operator">|</span> <span class="ruby-identifier">h</span>.<span class="ruby-identifier">sub!</span>(<span class="ruby-regexp re">/.*/</span>, <span class="ruby-operator">&amp;</span><span class="ruby-constant">RULE_SUBST</span>.<span class="ruby-identifier">method</span>(<span class="ruby-identifier">:%</span>))}
1800:     <span class="ruby-keyword kw">end</span>
1801:     <span class="ruby-identifier">headers</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">$config_h</span>
1802:     <span class="ruby-identifier">headers</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value str">'$(RUBY_EXTCONF_H)'</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">$extconf_h</span>
1803:     <span class="ruby-identifier">mfile</span>.<span class="ruby-identifier">print</span> <span class="ruby-value str">&quot;$(OBJS): &quot;</span>, <span class="ruby-identifier">headers</span>.<span class="ruby-identifier">join</span>(<span class="ruby-value str">' '</span>), <span class="ruby-value str">&quot;\n&quot;</span>
1804:   <span class="ruby-keyword kw">end</span>
1805: 
1806:   <span class="ruby-identifier">$makefile_created</span> = <span class="ruby-keyword kw">true</span>
1807: <span class="ruby-keyword kw">ensure</span>
1808:   <span class="ruby-identifier">mfile</span>.<span class="ruby-identifier">close</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">mfile</span>
1809: <span class="ruby-keyword kw">end</span></pre>
</body>
</html>
